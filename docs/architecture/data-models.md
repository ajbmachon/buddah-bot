# Data Models

## Overview

BuddahBot uses **minimal persistence**:
- **Session data:** JWT tokens (Auth.js, no database)
- **Chat history:** AssistantCloud (Assistance UI's native persistence layer)
- **User identification:** Auth.js session (email-based user ID for AssistantCloud)
- **Temporary state:** Client-side (Assistance UI runtime)

---

## 1. User (Auth Session)

**Storage:** JWT token (httpOnly cookie)

**Managed by:** Auth.js

**Structure:**
```typescript
interface User {
  id: string;
  email: string | null;
  name: string | null;
  image: string | null;
}

interface Session {
  user: User;
  expires: string; // ISO 8601
}
```

**Lifespan:** 30 days (configurable in Auth.js)

---

## 2. ChatMessage (Runtime)

**Storage:** Client memory + AssistantCloud

**Structure:**
```typescript
interface ChatMessage {
  role: "system" | "user" | "assistant";
  content: string;
  createdAt: string; // ISO 8601
}
```

**Usage:**
- **Client:** Assistance UI manages in-memory thread
- **Server:** Full thread sent with each request (stateless API)
- **Persistence:** Saved to AssistantCloud automatically after streaming

---

## 3. Thread (Chat History)

**Storage:** AssistantCloud (managed by Assistance UI)

**Structure:**
```typescript
// Managed internally by AssistantCloud
// No manual schema definition required
interface Thread {
  id: string;           // Auto-generated by cloud
  userId: string;       // From Auth.js session (user.email)
  title: string;        // Auto-generated from first message
  createdAt: string;
  updatedAt: string;
}
```

**Key pattern:**
- Managed entirely by AssistantCloud API
- No manual key management required
- Accessed via `<ThreadList />` component

**TTL:** Managed by AssistantCloud (check dashboard for retention policy)

---

## 4. NousAPIRequest

**Transient data structure** (not persisted)

```typescript
interface NousAPIRequest {
  model: "Hermes-4-405B" | "Hermes-4-70B";
  messages: ChatMessage[];
  temperature: number;
  max_tokens: number;
  stream: boolean;
}
```

**Usage:** Constructed in `/api/chat`, sent to Nous API, discarded

---

## 5. NousAPIResponse (Streaming)

**Transient data structure** (not persisted)

```typescript
interface NousStreamChunk {
  id: string;
  object: "chat.completion.chunk";
  created: number;
  model: string;
  choices: [{
    index: number;
    delta: {
      role?: "assistant";
      content?: string;
    };
    finish_reason: string | null;
  }];
}
```

**Usage:** Streamed from Nous API, proxied to client, content extracted for persistence

---

## 6. Authenticated User ID (Auth.js Session)

**Storage:** AssistantCloud workspace (tied to Auth.js session)

**Structure:**
```typescript
// User ID derived from Auth.js session
// Provided to AssistantCloud via /api/assistant-ui-token endpoint
interface AuthenticatedUser {
  userId: string; // session.user.email from Auth.js
  workspaceToken: string; // From AssistantCloud API
}
```

**Purpose:** Identify user across devices using Google account email

**Lifecycle:**
- **Created:** User signs in with Google OAuth (Epic 1)
- **Persisted:** Auth.js JWT session (30 days)
- **AssistantCloud Token:** Fetched via `/api/assistant-ui-token` on each page load
- **Lifespan:** Until session expires or user signs out

**Key Design Decisions:**
- User ID = Auth.js session.user.email (stable, never changes)
- Cross-device sync works (same Google account = same threads)
- No localStorage dependency (everything session-based)
- Requires active Auth.js session (users must be signed in)

**Usage Pattern:**
```typescript
// Client-side (app/assistant.tsx)
const cloud = new AssistantCloud({
  baseUrl: process.env.NEXT_PUBLIC_ASSISTANT_BASE_URL!,
  authToken: async () => {
    const res = await fetch('/api/assistant-ui-token');
    const { token } = await res.json();
    return token;
  },
});

// Server-side (app/api/assistant-ui-token/route.ts)
const session = await auth();
const workspaceToken = await fetchAssistantCloudToken(session.user.email);
return Response.json({ token: workspaceToken });
```

---

## Data Flow Summary

```mermaid
graph LR
    Client[Client] -->|Send messages| API[/api/chat]
    API -->|Validate| Session[JWT Session]
    API -->|Proxy| Nous[Nous API]
    Nous -->|Stream| API
    API -->|Stream| Client
    Client -->|Auto-save| Cloud[AssistantCloud]
    Cloud -->|Store| Messages[(Messages DB)]
    Client -->|Load history| Cloud
    Cloud -->|Retrieve| Messages
    Cloud -->|Authenticate| Session[Auth.js Session]
```

**Key points:**
- No database needed for MVP (AssistantCloud handles it)
- AssistantCloud manages chat history automatically
- User ID from Auth.js session (email-based, cross-device sync)
- JWT sessions mean no user database
- Full conversation context sent each request (stateless API)
- AssistantCloud handles all thread management (no custom code)

---

## Persistence Implementation

**See Epic 3 PRD** for complete AssistantCloud setup:
- **No custom functions needed** - framework handles everything
- Thread creation: Automatic on first message
- Thread retrieval: Built-in `<ThreadList />` component
- Message persistence: Automatic after streaming

**Setup time:** 5 minutes (cloud.assistant-ui.com signup + env vars)

---

## Future: Migration Options

**Consider migrating to self-hosted when:**
- Need cross-device sync with Auth.js integration
- Want full data ownership
- Require custom analytics on message patterns
- Need complex queries (search across conversations)

**Migration path documented in Epic 3 PRD.**
**Current approach (AssistantCloud) is production-ready** - migration only if business requires it.
