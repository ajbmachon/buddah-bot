# Story 1.2: Set Up Auth.js with Google OAuth and Email Providers

## Status
Draft

## Story
**As a** user,
**I want** to sign in with Google OAuth or receive a magic link via email,
**so that** I can access the chat application without managing passwords.

## Acceptance Criteria
1. Auth.js/NextAuth installed and configured with Google OAuth provider
2. Email provider configured with magic link authentication (no passwords)
3. JWT session strategy implemented (no database required for sessions)
4. Environment variables defined for:
   - `GOOGLE_CLIENT_ID`
   - `GOOGLE_CLIENT_SECRET`
   - `EMAIL_FROM`
   - `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS` (or `RESEND_API_KEY`)
   - `NEXTAUTH_SECRET`
   - `NEXTAUTH_URL`
5. `/api/auth/[...nextauth]/route.ts` properly configured
6. Custom login page created at `/login` with both auth options
7. Session accessible via `getServerSession()` in API routes and `useSession()` in client components

## Tasks / Subtasks

- [ ] Task 1: Install Auth.js v5 beta and configure centralized auth config (AC: 1, 3)
  - [ ] Install next-auth beta: `npm install next-auth@beta`
  - [ ] Create `lib/auth.ts` with NextAuth configuration
  - [ ] Configure Google OAuth provider with client ID/secret from env vars
  - [ ] Configure Resend email provider for magic links
  - [ ] Set JWT session strategy with 30-day maxAge
  - [ ] Add JWT and session callbacks for user ID handling
  - [ ] Export `{ handlers, auth, signIn, signOut }` for use across app

- [ ] Task 2: Create Auth.js API route handler (AC: 5)
  - [ ] Create `app/api/auth/[...nextauth]/route.ts`
  - [ ] Import and export `{ GET, POST }` handlers from `lib/auth.ts`
  - [ ] Verify route handles Auth.js requests (signin, callback, signout)

- [ ] Task 3: Create custom login page with dual auth options (AC: 6)
  - [ ] Create `app/(auth)/login/page.tsx` as client component
  - [ ] Add Google sign-in button using `signIn('google')`
  - [ ] Add email input field with submit button using `signIn('resend', { email })`
  - [ ] Style login page with Tailwind (centered card, BuddahBot branding)
  - [ ] Add loading states for both auth methods
  - [ ] Handle auth errors gracefully

- [ ] Task 4: Create auth error page (AC: 6)
  - [ ] Create `app/(auth)/auth/error/page.tsx`
  - [ ] Display user-friendly error messages based on error type
  - [ ] Add "Try Again" button linking back to `/login`

- [ ] Task 5: Set up environment variables and update example file (AC: 4)
  - [ ] Update `.env.local.example` with Auth.js variables
  - [ ] Document Google OAuth setup instructions (Google Cloud Console)
  - [ ] Document Resend setup instructions (or SMTP alternative)
  - [ ] Add `NEXTAUTH_SECRET` generation command to docs
  - [ ] Verify all required env vars are documented

- [ ] Task 6: Add SessionProvider to root layout for client access (AC: 7)
  - [ ] Create `components/auth/SessionProvider.tsx` wrapper
  - [ ] Import and wrap app with SessionProvider in `app/layout.tsx`
  - [ ] Verify `useSession()` hook works in client components
  - [ ] Verify `auth()` works in server components and API routes

- [ ] Task 7: Manual testing of authentication flow (AC: 1, 2, 6, 7)
  - [ ] Test Google OAuth: Click button → Redirected to Google → Callback → Session created
  - [ ] Test Email magic link: Submit email → Check inbox → Click link → Session created
  - [ ] Verify session persists after page refresh (JWT cookie)
  - [ ] Verify session accessible in both client and server contexts
  - [ ] Test sign-out functionality clears session

## Dev Notes

### Tech Stack Requirements
[Source: docs/architecture/tech-stack.md]

**Auth.js Version:**
- **Version:** 5.0.0-beta (production-ready beta)
- **Install:** `npm install next-auth@beta`
- **Breaking changes from v4:** New cookie names, import paths
- **Why beta:** Stable enough for greenfield project, v5 stable not yet released

**Email Provider Options:**
- **Resend (Recommended):** Simple API, generous free tier, built-in Auth.js support
- **SMTP (Alternative):** Any SMTP provider (Gmail, SendGrid, etc.)

### Backend Architecture
[Source: docs/architecture/backend-architecture.md]

**Centralized Auth Configuration:**
```typescript
// lib/auth.ts
import NextAuth from "next-auth";
import Google from "next-auth/providers/google";
import Resend from "next-auth/providers/resend";

export const { handlers, auth, signIn, signOut } = NextAuth({
  providers: [
    Google({
      clientId: process.env.AUTH_GOOGLE_ID!,
      clientSecret: process.env.AUTH_GOOGLE_SECRET!,
    }),
    Resend({
      from: process.env.EMAIL_FROM || "noreply@yourdomain.com",
    }),
  ],
  session: {
    strategy: "jwt",
    maxAge: 30 * 24 * 60 * 60, // 30 days
  },
  pages: {
    signIn: "/login",
    error: "/auth/error",
  },
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.id = user.id;
      }
      return token;
    },
    async session({ session, token }) {
      if (token && session.user) {
        session.user.id = token.sub!;
      }
      return session;
    },
  },
});
```

**API Route Handler:**
```typescript
// app/api/auth/[...nextauth]/route.ts
import { handlers } from "@/lib/auth";

export const { GET, POST } = handlers;
```

**Key Patterns:**
- **JWT Sessions:** No database needed, sessions stored in httpOnly cookies
- **Dual Providers:** Google OAuth (primary) + Email magic links (fallback)
- **Centralized Config:** Single source of truth in `lib/auth.ts`
- **Custom Pages:** Login at `/login`, errors at `/auth/error`

### Project Structure
[Source: docs/architecture/unified-project-structure.md]

**Files to Create:**
```
app/
├── (auth)/
│   ├── login/
│   │   └── page.tsx             # Custom login page
│   └── auth/
│       └── error/
│           └── page.tsx         # Auth error page
├── api/
│   └── auth/
│       └── [...nextauth]/
│           └── route.ts         # Auth.js handler
├── layout.tsx                   # Update with SessionProvider
└── globals.css                  # (already exists)

components/
└── auth/
    └── SessionProvider.tsx      # Client SessionProvider wrapper

lib/
└── auth.ts                      # Centralized auth config
```

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Critical Rules:**
1. **Session Validation:** Always validate sessions in protected routes (Story 1.3)
2. **Client Components:** Login page must use `"use client"` directive for `signIn()`
3. **Error Handling:** Handle auth errors gracefully (network, user cancellation, invalid email)

**Naming Conventions:**
- Components: `SessionProvider.tsx`, `LoginPage.tsx`
- API Routes: `route.ts` (lowercase)
- Functions: `signIn()`, `signOut()`, `auth()`

### Environment Variables Setup

**Required Variables:**
```bash
# Auth.js Core
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=                          # Generate with: openssl rand -base64 32

# Google OAuth
AUTH_GOOGLE_ID=
AUTH_GOOGLE_SECRET=

# Email Provider (Option 1: Resend - Recommended)
RESEND_API_KEY=
EMAIL_FROM=noreply@yourdomain.com

# Email Provider (Option 2: SMTP)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=
SMTP_PASS=
EMAIL_FROM=noreply@yourdomain.com
```

**Google OAuth Setup Instructions:**
1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create new project: "BuddahBot"
3. Enable Google+ API
4. Create OAuth 2.0 credentials (Web application)
5. Add authorized redirect URI: `http://localhost:3000/api/auth/callback/google`
6. Copy Client ID and Client Secret to `.env.local`

**Resend Setup Instructions:**
1. Sign up at [resend.com](https://resend.com/)
2. Verify domain or use Resend's test domain
3. Create API key in dashboard
4. Copy API key to `.env.local` as `RESEND_API_KEY`
5. Set `EMAIL_FROM` to verified email address

### Frontend Architecture Notes
[Source: docs/architecture/frontend-architecture.md]

**Login Page Implementation:**
- Use Tailwind for styling (centered card, responsive)
- Add BuddahBot branding (logo, tagline)
- Loading states for auth actions (button disabled, spinner)
- Error messages displayed inline

**SessionProvider Pattern:**
```typescript
// components/auth/SessionProvider.tsx
"use client";

import { SessionProvider as NextAuthSessionProvider } from "next-auth/react";

export function SessionProvider({ children }: { children: React.ReactNode }) {
  return <NextAuthSessionProvider>{children}</NextAuthSessionProvider>;
}
```

```typescript
// app/layout.tsx (update)
import { SessionProvider } from "@/components/auth/SessionProvider";

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <SessionProvider>
          {children}
        </SessionProvider>
      </body>
    </html>
  );
}
```

### Important Notes from Previous Stories

**Story 1.1 Completion Notes:**
- Next.js project initialized with App Router and TypeScript
- Assistance UI installed and configured
- Basic chat page created at `app/(chat)/page.tsx`
- Placeholder `/api/chat` route exists (returns 200)
- Project structure follows route group pattern

**Integration Points:**
- Chat page (`app/(chat)/page.tsx`) will be protected in Story 1.3
- `/api/chat` route will add session validation in Story 1.3
- Root layout already exists - update it to add SessionProvider

### Testing

[Source: docs/architecture/testing-strategy.md]

**Manual Testing Checklist:**

**Google OAuth Flow:**
- [ ] Navigate to `/login` - page loads with Google button
- [ ] Click "Sign in with Google" - redirected to Google consent screen
- [ ] Grant permissions - redirected back to app with session created
- [ ] Verify session cookie exists in browser DevTools (Application tab)
- [ ] Refresh page - session persists (not logged out)
- [ ] Check Vercel logs - no errors during OAuth flow

**Email Magic Link Flow:**
- [ ] Navigate to `/login` - page loads with email input
- [ ] Enter valid email and submit - success message displayed
- [ ] Check email inbox - magic link email received
- [ ] Click magic link - redirected to app with session created
- [ ] Verify session cookie exists
- [ ] Refresh page - session persists

**Session Access:**
- [ ] Test `useSession()` in client component - returns session data
- [ ] Test `auth()` in server component - returns session data
- [ ] Test `auth()` in API route - returns session data
- [ ] Sign out - session cleared, cookie removed

**Error Handling:**
- [ ] Test invalid email format - error message displayed
- [ ] Test Google OAuth cancellation - redirected to error page
- [ ] Test expired magic link - error page displays helpful message

**Environment Variables:**
- [ ] Verify all required env vars are set in `.env.local`
- [ ] Verify `.env.local.example` has complete documentation
- [ ] Test without env vars - app fails gracefully with clear error

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
*(To be filled by dev agent during implementation)*

### Debug Log References
*(To be filled by dev agent during implementation)*

### Completion Notes List
*(To be filled by dev agent during implementation)*

### File List
*(To be filled by dev agent during implementation)*

## QA Results
*(To be filled by QA agent after implementation)*

---
