# Story 1.3: Protect Chat Routes with Authentication Middleware

## Status
Draft

## Story
**As a** user,
**I want** the chat interface to be protected by authentication,
**so that** only signed-in users can access conversations.

## Acceptance Criteria
1. Next.js middleware configured to protect `/` and `/chat` routes
2. Unauthenticated users redirected to `/login` page
3. Authenticated users can access chat interface
4. Session data available in protected routes
5. Sign-out functionality working correctly

## Tasks / Subtasks

- [ ] Task 1: Create Next.js middleware for route protection (AC: 1, 2, 3)
  - [ ] Create `middleware.ts` at project root
  - [ ] Import `auth` function from `lib/auth.ts`
  - [ ] Implement middleware logic: check `req.auth` for session
  - [ ] Allow public routes: `/login`, `/api/auth/*`, `/_next/*`, `/favicon.ico`
  - [ ] Redirect unauthenticated users to `/login` for all other routes
  - [ ] Configure matcher to apply middleware to all routes except static files
  - [ ] Verify middleware runs on Edge runtime (Auth.js v5 supports this)

- [ ] Task 2: Add session validation to chat API route (AC: 4)
  - [ ] Update `app/api/chat/route.ts` to validate session
  - [ ] Call `auth()` at start of POST handler
  - [ ] Return 401 Unauthorized if no session found
  - [ ] Return structured error JSON: `{ error: { code: "unauthorized", message: "Authentication required", statusCode: 401 } }`
  - [ ] Verify session data includes user ID

- [ ] Task 3: Update chat page to handle authentication state (AC: 3, 4)
  - [ ] Update `app/(chat)/page.tsx` to use `useSession()` hook
  - [ ] Add loading state while session is being fetched
  - [ ] Display user info (name, email) in chat header
  - [ ] Add sign-out button in chat interface
  - [ ] Handle session errors gracefully

- [ ] Task 4: Implement sign-out functionality (AC: 5)
  - [ ] Create sign-out button component in chat interface
  - [ ] Call `signOut()` on button click
  - [ ] Configure sign-out to redirect to `/login` page
  - [ ] Verify session cookie is cleared after sign-out
  - [ ] Test sign-out from both client and server contexts

- [ ] Task 5: Manual testing of protected routes (AC: 1, 2, 3, 4, 5)
  - [ ] Test unauthenticated access to `/` → redirects to `/login`
  - [ ] Test unauthenticated access to `/chat` → redirects to `/login`
  - [ ] Test authenticated access to `/` → chat page loads
  - [ ] Test `/api/chat` without session → returns 401
  - [ ] Test `/api/chat` with session → returns 200 (or streams)
  - [ ] Test sign-out → redirects to `/login` and clears session
  - [ ] Test session persistence → refresh page, still authenticated

## Dev Notes

### Backend Architecture
[Source: docs/architecture/backend-architecture.md]

**Middleware Implementation:**
```typescript
// middleware.ts
import { auth } from "@/lib/auth";
import { NextResponse } from "next/server";

export default auth((req) => {
  const isLoggedIn = !!req.auth;
  const { pathname } = req.nextUrl;

  // Allow public routes
  if (
    pathname.startsWith("/login") ||
    pathname.startsWith("/api/auth") ||
    pathname.startsWith("/_next") ||
    pathname === "/favicon.ico"
  ) {
    return NextResponse.next();
  }

  // Redirect to login if not authenticated
  if (!isLoggedIn) {
    return NextResponse.redirect(new URL("/login", req.url));
  }

  return NextResponse.next();
});

export const config = {
  matcher: ["/((?!_next/static|_next/image).*)"],
};
```

**Key Patterns:**
- **Edge Runtime:** Middleware runs on Edge (Auth.js v5 supports this)
- **Public Routes:** Login page and auth API must be accessible without session
- **Static Files:** `_next` assets excluded from middleware
- **Redirect Pattern:** Use `NextResponse.redirect()` with full URL

**Chat API Session Validation:**
```typescript
// app/api/chat/route.ts (update)
export async function POST(req: Request) {
  // 1. Validate session (FIRST ACTION)
  const session = await auth();
  if (!session?.user) {
    return new Response(
      JSON.stringify({
        error: {
          code: "unauthorized",
          message: "Authentication required",
          statusCode: 401
        }
      }),
      { status: 401, headers: { "Content-Type": "application/json" } }
    );
  }

  // 2. Continue with chat logic...
  const { messages } = await req.json();
  // ... rest of handler
}
```

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Critical Rule #3: Auth Validation First**
```typescript
// ✅ DO: Check session at top of protected routes
export async function POST(req: Request) {
  const session = await auth();
  if (!session?.user) {
    return new Response('Unauthorized', { status: 401 });
  }
  // ... rest of handler
}

// ❌ DON'T: Skip session validation
export async function POST(req: Request) {
  const { messages } = await req.json();
  // Forgot to check session!
}
```

**Why:** Security. All protected routes must validate authentication.

### Project Structure
[Source: docs/architecture/unified-project-structure.md]

**Files to Create/Update:**
```
buddah-bot/
├── middleware.ts                        # NEW: Route protection middleware
├── app/
│   ├── (chat)/
│   │   └── page.tsx                     # UPDATE: Add session handling and sign-out
│   └── api/
│       └── chat/
│           └── route.ts                 # UPDATE: Add session validation
```

**Middleware Location:**
- Must be at project root (`middleware.ts`)
- Not inside `app/` directory
- Runs before all routes (except static files)

### Frontend Architecture Notes
[Source: docs/architecture/frontend-architecture.md]

**Chat Page Session Handling:**
```typescript
// app/(chat)/page.tsx (update)
"use client";

import { useSession, signOut } from "next-auth/react";
import { useDataStreamRuntime } from "@assistant-ui/react-data-stream";
import { AssistantRuntimeProvider, Thread } from "@assistant-ui/react";

export default function ChatPage() {
  const { data: session, status } = useSession();
  const runtime = useDataStreamRuntime({ api: "/api/chat" });

  // Loading state
  if (status === "loading") {
    return (
      <div className="h-screen flex items-center justify-center">
        <p className="text-gray-500">Loading...</p>
      </div>
    );
  }

  // This shouldn't happen (middleware redirects), but handle gracefully
  if (!session) {
    return null;
  }

  return (
    <AssistantRuntimeProvider runtime={runtime}>
      <main className="h-screen bg-gray-50">
        <div className="h-full flex flex-col">
          {/* Header with user info and sign-out */}
          <header className="flex justify-between items-center p-4 bg-white border-b">
            <h1 className="text-xl font-semibold">BuddahBot</h1>
            <div className="flex items-center gap-4">
              <span className="text-sm text-gray-600">
                {session.user?.name || session.user?.email}
              </span>
              <button
                onClick={() => signOut({ callbackUrl: "/login" })}
                className="text-sm text-red-600 hover:text-red-700"
              >
                Sign Out
              </button>
            </div>
          </header>

          {/* Chat interface */}
          <div className="flex-1 overflow-hidden">
            <Thread />
          </div>
        </div>
      </main>
    </AssistantRuntimeProvider>
  );
}
```

**Key UI Elements:**
- User name/email displayed in header
- Sign-out button with confirmation (optional)
- Loading state while session is being fetched
- Graceful handling of missing session (shouldn't happen with middleware)

### Important Notes from Previous Stories

**Story 1.1 Completion Notes:**
- Basic chat page exists at `app/(chat)/page.tsx`
- Placeholder `/api/chat` route exists
- Both need updates for authentication

**Story 1.2 Completion Notes:**
- Auth.js configured in `lib/auth.ts`
- `auth()` function available for server-side session access
- `useSession()` hook available for client-side session access
- `signOut()` function available for logout

**Integration Points:**
- Middleware protects ALL routes except public ones
- Chat page displays user info and sign-out button
- Chat API validates session before processing requests

### Tech Stack Requirements
[Source: docs/architecture/tech-stack.md]

**Auth.js v5 Beta:**
- Middleware support on Edge runtime (new in v5)
- `auth()` function works in middleware, API routes, and server components
- `useSession()` hook for client components

**Next.js 15.5.4:**
- Middleware runs on Edge runtime by default
- `middleware.ts` must be at project root
- Matcher config excludes static assets

### Testing

[Source: docs/architecture/testing-strategy.md]

**Manual Testing Checklist:**

**Middleware Protection:**
- [ ] Open browser in incognito mode (no session)
- [ ] Navigate to `http://localhost:3000/` → redirected to `/login`
- [ ] Navigate to `http://localhost:3000/chat` → redirected to `/login`
- [ ] Verify `/login` page loads (not redirected)
- [ ] Verify `/api/auth/signin` accessible (not redirected)
- [ ] Sign in with Google or email
- [ ] Navigate to `/` → chat page loads (not redirected)

**API Route Protection:**
- [ ] Open browser DevTools → Network tab
- [ ] Sign out to clear session
- [ ] Send POST to `/api/chat` with `fetch()` → returns 401 Unauthorized
- [ ] Verify error response JSON: `{ error: { code: "unauthorized", ... } }`
- [ ] Sign in
- [ ] Send POST to `/api/chat` → returns 200 (or streams)

**Session Availability:**
- [ ] After sign-in, verify chat page displays user name/email in header
- [ ] Open browser DevTools → Console
- [ ] Check session data is accessible (no errors)
- [ ] Refresh page → session persists (user still logged in)

**Sign-Out Flow:**
- [ ] Click "Sign Out" button in chat interface
- [ ] Verify redirected to `/login` page
- [ ] Verify session cookie cleared (DevTools → Application → Cookies)
- [ ] Attempt to navigate to `/` → redirected to `/login` (middleware working)
- [ ] Verify `/api/chat` returns 401 after sign-out

**Edge Cases:**
- [ ] Test session expiration (set maxAge to 60s in dev) → auto-redirect to login
- [ ] Test concurrent tabs → sign out in one tab, other tab redirects
- [ ] Test direct API calls without session → consistent 401 response

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
*(To be filled by dev agent during implementation)*

### Debug Log References
*(To be filled by dev agent during implementation)*

### Completion Notes List
*(To be filled by dev agent during implementation)*

### File List
*(To be filled by dev agent during implementation)*

## QA Results
*(To be filled by QA agent after implementation)*

---
