# Story 1.4: Deploy to Vercel with Environment Variables

## Status
Done

## Story
**As a** developer,
**I want** to deploy the application to Vercel with all required environment variables configured,
**so that** authentication works in production and the app is accessible to users.

## Acceptance Criteria
1. Project connected to Vercel via GitHub/GitLab integration
2. All environment variables configured in Vercel project settings:
   - `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET`
   - Email provider credentials
   - `NEXTAUTH_SECRET` and `NEXTAUTH_URL` (production URL)
3. OAuth callback URLs configured in Google Cloud Console for production domain
4. Deployment successful with no build errors
5. Production site accessible at Vercel-provided URL
6. Authentication flow working end-to-end in production:
   - Google OAuth sign-in successful
   - Email magic link sign-in successful
   - Protected routes properly enforcing authentication

## Tasks / Subtasks

- [x] Task 1: Connect project to Vercel (AC: 1)
  - [x] Commit all changes to git repository
  - [x] Push code to GitHub (or GitLab)
  - [x] Sign up/login to Vercel dashboard
  - [x] Click "New Project" and import GitHub repository
  - [x] Select "buddah-bot" repository
  - [x] Configure project settings (default Next.js settings should work)
  - [x] Do NOT deploy yet (skip initial deployment)

- [x] Task 2: Configure environment variables in Vercel (AC: 2)
  - [x] Navigate to Project Settings → Environment Variables
  - [x] Add production environment variables:
    - `NEXTAUTH_SECRET` = (generate new secret with `openssl rand -base64 32`)
    - `AUTH_GOOGLE_ID` = (copy from local `.env.local`)
    - `AUTH_GOOGLE_SECRET` = (copy from local `.env.local`)
    - `RESEND_API_KEY` = (copy from local `.env.local` or create new)
    - `EMAIL_FROM` = (verified email address)
    - `NOUS_API_BASE_URL` = `https://api.nousresearch.com/v1`
    - `NOUS_API_KEY` = (from Nous Portal account)
    - `HERMES_MODEL` = `Hermes-4-405B`
  - [x] Set all variables for "Production" environment
  - [x] Set for "Preview" environment (for testing)
  - [x] Do NOT set for "Development" (use local `.env.local`)

- [x] Task 3: Update Google OAuth callback URLs for production (AC: 3)
  - [x] Go to Google Cloud Console → APIs & Services → Credentials
  - [x] Edit OAuth 2.0 Client ID for BuddahBot
  - [x] Add authorized redirect URI: `https://[your-project].vercel.app/api/auth/callback/google`
  - [x] Keep localhost redirect URI for local development
  - [x] Save changes

- [x] Task 4: Deploy to production and verify deployment (AC: 4, 5)
  - [x] Return to Vercel dashboard
  - [x] Click "Deploy" to trigger first deployment
  - [x] Monitor build logs for errors
  - [x] Verify build completes successfully (green checkmark)
  - [x] Note production URL: `https://[your-project].vercel.app`
  - [x] Fixed Auth.js v5 compatibility issues (AUTH_SECRET vs NEXTAUTH_SECRET)
  - [x] Verified trustHost: true enables auto URL detection

- [x] Task 5: Test authentication in production (AC: 6)
  - [x] Navigate to production URL in browser
  - [x] Verify redirected to `/login` page
  - [x] Test Google OAuth:
    - [x] Click "Sign in with Google"
    - [x] Complete Google consent screen
    - [x] Verify redirected back to production site with session
    - [x] Verify chat interface loads
  - [ ] Test email magic link:
    - [ ] Sign out from previous test
    - [ ] Enter email and submit
    - [ ] Check email inbox for magic link
    - [ ] Click magic link
    - [ ] Verify redirected to production site with session
    - [ ] Verify chat interface loads
  - [x] Test protected routes:
    - [x] Sign out
    - [x] Navigate to `/` → redirected to `/login`
    - [x] Sign in again
    - [x] Navigate to `/` → chat interface loads

- [ ] Task 6: Test chat streaming in production (AC: 6)
  - [ ] Sign in to production site
  - [ ] Send test message: "Hello, can you introduce yourself?"
  - [ ] Verify streaming response appears within 2 seconds
  - [ ] Verify panel format (3 teachers responding)
  - [ ] Verify response quality matches Nous Portal testing
  - [ ] Test regenerate button (if applicable)
  - [ ] Check Vercel function logs for errors

- [x] Task 7: Document production URLs and setup in README (AC: 5)
  - [x] Create or update `README.md` with:
    - Production URL
    - Local development setup instructions
    - Environment variable setup instructions
    - Google OAuth setup instructions
    - Resend/email provider setup instructions
  - [x] Add deployment instructions for future updates (DEPLOYMENT.md created)
  - [x] Commit and push updated README

- [ ] Task 8: Invite initial users from trusted circle (AC: 6)
  - [ ] Share production URL with friends/family
  - [ ] Provide brief instructions: "Sign in with Google or email"
  - [ ] Monitor for initial user feedback
  - [ ] Check Vercel logs for errors during initial usage
  - [ ] Address any issues discovered by early users

## Dev Notes

### Vercel Deployment Architecture
[Source: docs/architecture/tech-stack.md, backend-architecture.md]

**Vercel Integration:**
- **CI/CD:** Automatic deployment on git push (main branch → production, other branches → preview)
- **Serverless Functions:** Next.js API routes automatically deployed as serverless functions
- **Edge Network:** Global CDN for static assets and Edge runtime functions
- **Environment Variables:** Managed via Vercel dashboard, encrypted at rest
- **Monitoring:** Built-in function logs and analytics

**Runtime Configurations:**
- `/api/chat` → Edge runtime (25s timeout, global distribution)
- `/api/auth/*` → Node runtime (10s timeout, OAuth handling)
- Middleware → Edge runtime (authentication checks)

### Environment Variables Strategy

**Production vs Development:**
```bash
# Local Development (.env.local - NOT committed to git)
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=local_dev_secret_123
AUTH_GOOGLE_ID=...
AUTH_GOOGLE_SECRET=...
RESEND_API_KEY=...
EMAIL_FROM=noreply@buddahbot.local
NOUS_API_BASE_URL=https://api.nousresearch.com/v1
NOUS_API_KEY=...
HERMES_MODEL=Hermes-4-405B

# Production (Vercel Dashboard - NOT in git)
NEXTAUTH_URL=https://buddah-bot-abc123.vercel.app
NEXTAUTH_SECRET=<NEW_SECRET_FOR_PRODUCTION>
AUTH_GOOGLE_ID=<SAME_AS_LOCAL>
AUTH_GOOGLE_SECRET=<SAME_AS_LOCAL>
RESEND_API_KEY=<SAME_AS_LOCAL_OR_NEW>
EMAIL_FROM=noreply@buddahbot.com
NOUS_API_BASE_URL=https://api.nousresearch.com/v1
NOUS_API_KEY=<SAME_AS_LOCAL>
HERMES_MODEL=Hermes-4-405B
```

**Critical Security Notes:**
- **NEVER commit `.env.local` to git** (already in `.gitignore`)
- **Generate NEW `NEXTAUTH_SECRET` for production** (don't reuse local)
- **Use Vercel dashboard for environment variables** (not in code)
- **Google OAuth credentials can be same for local and prod** (multiple redirect URIs supported)

### Google OAuth Multi-Environment Setup

**Authorized Redirect URIs (both needed):**
```
http://localhost:3000/api/auth/callback/google        # Local development
https://buddah-bot-abc123.vercel.app/api/auth/callback/google  # Production
```

**Why both:**
- Same OAuth client can have multiple redirect URIs
- No need for separate dev/prod OAuth apps
- Simplifies credential management

### Deployment Checklist

**Pre-Deployment:**
- [ ] All code committed and pushed to GitHub/GitLab
- [ ] `.env.local` NOT committed (verify in `.gitignore`)
- [ ] All environment variables documented in `.env.local.example`
- [ ] Google OAuth client has production callback URL added
- [ ] Resend API key valid and email domain verified

**During Deployment:**
- [ ] Vercel project created and connected to git repo
- [ ] All environment variables configured in Vercel dashboard
- [ ] Build succeeds with no errors
- [ ] Deployment logs checked for warnings

**Post-Deployment:**
- [ ] Production URL accessible
- [ ] Authentication flows tested (Google + email)
- [ ] Chat streaming tested with real message
- [ ] Protected routes enforce authentication
- [ ] Vercel function logs show no errors

### Vercel Dashboard Configuration

**Project Settings:**
- **Framework Preset:** Next.js (auto-detected)
- **Build Command:** `npm run build` (default)
- **Output Directory:** `.next` (default)
- **Install Command:** `npm install` (default)
- **Node Version:** 18.x (default, sufficient for Next.js 15.5.4)

**Environment Variables Configuration:**
- **Scope:** Production (required), Preview (optional), Development (skip - use local)
- **Encryption:** Vercel encrypts all environment variables at rest
- **Access:** Only project members can view/edit

### Troubleshooting Common Deployment Issues

**Build Failures:**
- Check Vercel build logs for TypeScript errors
- Verify all dependencies in `package.json`
- Test local build: `npm run build` before deploying

**Authentication Issues:**
- Verify `NEXTAUTH_URL` matches actual production URL
- Check Google OAuth callback URL includes production domain
- Verify `NEXTAUTH_SECRET` is set (generate new for production)
- Check Vercel function logs for auth errors

**Streaming Issues:**
- Verify `NOUS_API_KEY` is valid and has credits
- Check Edge function timeout (25s limit)
- Monitor Vercel function logs for upstream API errors
- Test Nous API directly with curl to isolate issues

**Environment Variable Issues:**
- Verify all required variables are set in Vercel dashboard
- Check variable names match code (typos common)
- Redeploy after updating environment variables (not applied to running deployment)

### Important Notes from Previous Stories

**Story 1.1 Completion Notes:**
- Project initialized with Next.js 15.5.4 and TypeScript
- Assistance UI configured
- Basic chat page exists

**Story 1.2 Completion Notes:**
- Auth.js configured with Google OAuth and email providers
- JWT sessions (no database required)
- Login page and auth error page created

**Story 1.3 Completion Notes:**
- Middleware protects all routes except public paths
- Chat API validates session
- Sign-out functionality implemented

**Integration Points:**
- All authentication flows depend on correct environment variables
- Google OAuth requires production callback URL configuration
- Email magic links require Resend (or SMTP) configuration
- Chat streaming requires valid Nous API key

### Testing Strategy

[Source: docs/architecture/testing-strategy.md]

**Manual Testing in Production:**

**Initial Deployment Verification:**
- [ ] Production URL loads (not 404 or 500 error)
- [ ] SSL certificate valid (https with green lock)
- [ ] Favicon and branding assets load
- [ ] `/login` page renders correctly
- [ ] Browser console shows no errors on load

**Authentication Flow Testing:**
- [ ] Google OAuth:
  - Click "Sign in with Google"
  - Complete consent screen
  - Redirected back to production site
  - Session created (check cookies in DevTools)
  - Chat interface accessible
- [ ] Email magic link:
  - Enter valid email address
  - Submit form
  - Receive email within 60 seconds
  - Click magic link in email
  - Redirected to production site
  - Session created
  - Chat interface accessible

**Protected Routes Testing:**
- [ ] Without session: Navigate to `/` → redirected to `/login`
- [ ] With session: Navigate to `/` → chat interface loads
- [ ] Sign out → redirected to `/login`
- [ ] Attempt to access `/` after sign-out → redirected to `/login`

**Chat Functionality Testing:**
- [ ] Send message: "Hello"
- [ ] Streaming response starts within 2 seconds
- [ ] Panel format displays (3 teachers)
- [ ] Full response completes without errors
- [ ] Response quality matches expectations
- [ ] Test message length limits (max 2000 chars)
- [ ] Test conversation history (if implemented)

**Edge Case Testing:**
- [ ] Test session expiration (wait 30 days or manually expire cookie)
- [ ] Test invalid OAuth callback (simulate by changing Google OAuth config)
- [ ] Test expired magic link (wait 24 hours or regenerate)
- [ ] Test network failures (disable internet during streaming)
- [ ] Test concurrent sessions (multiple tabs, multiple devices)

**Monitoring and Logs:**
- [ ] Check Vercel function logs for errors
- [ ] Monitor function execution time (should be <25s for chat)
- [ ] Check for any rate limiting from Nous API
- [ ] Monitor email delivery success rate (Resend dashboard)

### Post-Deployment Monitoring

**Vercel Dashboard Metrics:**
- **Function Invocations:** Monitor `/api/chat` and `/api/auth` call volume
- **Execution Duration:** Ensure chat streaming completes within 25s Edge limit
- **Error Rate:** Should be <1% for normal operation
- **Build Status:** Track deployment success rate

**User Feedback Collection:**
- Share production URL with 3-5 initial users
- Request feedback on:
  - Authentication ease (Google vs email preference)
  - Chat response quality
  - Streaming speed
  - Overall user experience
- Document feedback for post-MVP iterations

**Known Limitations (Document for Users):**
- 25s Edge timeout (long responses may be truncated)
- Nous API rate limits (handle gracefully with error messages)
- Email delivery delays (magic links may take 1-2 minutes)
- No conversation history yet (coming in Epic 3)

### Next Steps After Deployment

**Immediate:**
- [ ] Share production URL with trusted circle (friends/family)
- [ ] Monitor Vercel logs for first 24 hours
- [ ] Address any critical issues discovered by early users

**Post-MVP (Future Epics):**
- Epic 2: Implement actual chat streaming with Nous API and panel mode prompts
- Epic 3: Add conversation history persistence (Vercel KV/Redis)
- Epic 4: Polish UI, add analytics, optimize performance

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
- Fixed middleware NEXTAUTH_URL validation error (comparison-claude branch)
- Auth.js v5 environment variable compatibility issue resolved
- Commits: cf6ebc7, eaecc34

### Completion Notes List
1. **Auth.js v5 Environment Variable Compatibility**
   - Updated validator in `lib/auth.ts` to accept both `AUTH_SECRET` and `NEXTAUTH_SECRET`
   - Reason: Auth.js v5 maintains backward compatibility with v4 variable names
   - Fixed production deployment error where NEXTAUTH_SECRET was set but validator only checked AUTH_SECRET

2. **URL Auto-Detection with trustHost**
   - Confirmed `trustHost: true` enables automatic URL detection from request headers
   - NEXTAUTH_URL is optional in production when trustHost is enabled
   - Vercel automatically provides X-Forwarded-Host header for URL inference

3. **Documentation Created**
   - Created comprehensive `DEPLOYMENT.md` guide with current UI instructions (October 2025)
   - Updated `README.md` with quick start and deployment overview
   - Created `.env.local.example` template (blocked by hook, needs manual creation)

4. **Preview vs Production Environment Variables**
   - All env vars must be set for both Production AND Preview environments in Vercel
   - Preview deployments use dynamic URLs, making Google OAuth testing challenging
   - Recommended: Use email magic links for preview testing, OAuth for production only

5. **Email Provider Note**
   - Resend provider commented out in lib/auth.ts (requires database adapter)
   - Email magic link testing deferred to post-deployment
   - Google OAuth confirmed working in production

### File List
**Modified:**
- `lib/auth.ts` - Updated environment variable validation (AUTH_SECRET/NEXTAUTH_SECRET compatibility)
- `middleware.ts` - No changes needed (Auth.js v5 pattern already correct)
- `README.md` - Added comprehensive setup and deployment instructions
- `DEPLOYMENT.md` - Created detailed deployment guide with current UI navigation

**Created:**
- `DEPLOYMENT.md` - Complete step-by-step deployment guide
- `.env.local.example` - Template file (creation blocked by hook)

**Commits:**
- cf6ebc7: "Fix: Use AUTH_SECRET instead of NEXTAUTH_SECRET, remove NEXTAUTH_URL requirement"
- eaecc34: "Fix: Accept both AUTH_SECRET and NEXTAUTH_SECRET for v4/v5 compatibility"

## QA Results

**QA Status:** ✅ PASS

**Reviewed By:** User (manual testing)
**Review Date:** 2025-10-08
**Decision:** Approved for production

### Test Results Summary

**Core Functionality:**
- ✅ Vercel deployment successful (production and preview environments)
- ✅ Environment variables configured correctly
- ✅ Google OAuth authentication working end-to-end
- ✅ Protected routes enforcing authentication properly
- ✅ Middleware executing without errors
- ✅ Auth.js v5 compatibility confirmed

**Acceptance Criteria Verification:**

| AC | Requirement | Status | Notes |
|----|-------------|--------|-------|
| 1 | Project connected to Vercel | ✅ PASS | GitHub integration working |
| 2 | Environment variables configured | ✅ PASS | All vars set for Production + Preview |
| 3 | OAuth callback URLs configured | ✅ PASS | Google Cloud Console updated |
| 4 | Deployment successful | ✅ PASS | Build logs clean, no errors |
| 5 | Production site accessible | ✅ PASS | URL working, SSL valid |
| 6 | Authentication working | ✅ PASS | Google OAuth confirmed, protected routes enforced |

**Known Limitations (Deferred):**
- Email magic links not tested (Resend provider requires database adapter - future story)
- Chat streaming not tested (Nous API integration - separate epic)

**Technical Debt Notes:**
- `.env.local.example` file creation blocked by hook - requires manual creation
- Preview environment OAuth testing challenging due to dynamic URLs

**Recommendation:** Story meets all core acceptance criteria. Deferred items are appropriately scoped for future work.

**Gate Decision:** PASS - Ready for production use

---
