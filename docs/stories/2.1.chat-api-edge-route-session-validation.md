# Story 2.1: Create Chat API Edge Route with Session Validation

## Status
Ready for Review

## Story
**As a** developer,
**I want** to create an Edge runtime API route that validates user sessions,
**so that** only authenticated users can send chat requests.

## Acceptance Criteria
1. `/api/chat/route.ts` created with `export const runtime = 'edge'`
2. POST handler implemented accepting `{ messages }` from Assistance UI
3. Session validation using `getServerSession()` from Auth.js
4. Unauthenticated requests return 401 Unauthorized
5. Malformed requests return 400 Bad Request with clear error messages
6. Edge function deploys successfully to Vercel

## Tasks / Subtasks

- [x] Task 1: Create Edge runtime API route file (AC: 1)
  - [x] Create file `app/api/chat/route.ts`
  - [x] Add `export const runtime = 'edge'` directive
  - [x] Add `export const maxDuration = 25` (Vercel Edge limit)
  - [x] Import required dependencies: `auth` from `@/lib/auth`

- [x] Task 2: Implement POST handler with request parsing (AC: 2)
  - [x] Define POST async function handler accepting `Request` object
  - [x] Parse request body with `await req.json()`
  - [x] Extract `messages` array from request body
  - [x] Add basic logging for debugging (request ID generation)

- [x] Task 3: Add session validation logic (AC: 3, 4)
  - [x] Call `await auth()` to get session (Auth.js v5)
  - [x] Check if `session?.user` exists
  - [x] If no session, return 401 response with JSON error:
    ```json
    {
      "error": {
        "code": "unauthorized",
        "message": "Authentication required",
        "statusCode": 401
      }
    }
    ```
  - [x] Set proper headers: `Content-Type: application/json`

- [x] Task 4: Add input validation (AC: 5)
  - [x] Installed `zod` package
  - [x] Implemented basic validation (messages array check, count validation 1-20)
  - [x] **Changed approach**: Removed strict Zod schema due to UIMessage format complexity
  - [x] Let AI SDK's `convertToModelMessages()` handle validation
  - [x] Return 400/422 for validation errors with clear messages

- [x] Task 5: Install Vercel AI SDK dependencies (AC: 6)
  - [x] Packages already installed: `ai` v5.0.59 and `@ai-sdk/openai` v2.0.42
  - [x] Verified in package.json
  - [x] AI SDK integration working

- [x] Task 6: Add placeholder AI SDK response for testing (AC: 6)
  - [x] Import `streamText`, `convertToModelMessages`, `UIMessage` from `ai`
  - [x] Import `openai` from `@ai-sdk/openai`
  - [x] Create streamText call with `gpt-4o-mini` placeholder model
  - [x] Use `convertToModelMessages()` to transform UIMessage → ModelMessage
  - [x] Return `result.toUIMessageStreamResponse()` (not `toTextStreamResponse()`)
  - [x] Edge function deploys and runs successfully

- [x] Task 7: Test edge cases and error handling
  - [x] Manual browser testing completed
  - [x] Authenticated user can send messages successfully
  - [x] Streaming responses work end-to-end
  - [x] Request logging functional (request ID, user email, message count)

## Dev Notes

### Edge Runtime Configuration
[Source: docs/architecture/backend-architecture.md, tech-stack.md]

**Critical Edge Runtime Rules:**
- **File location:** `app/api/chat/route.ts`
- **Runtime directive:** `export const runtime = 'edge'` (MUST be at top of file)
- **Max duration:** `export const maxDuration = 25` (Vercel Edge limit - 25 seconds)
- **No Node.js APIs:** Cannot use `Buffer`, `fs`, `path`, or other Node-specific modules
- **Auth.js v5 compatibility:** Auth.js v5 supports Edge runtime for session validation

**Why Edge Runtime:**
- Global distribution (lower latency)
- Sub-2s time-to-first-token requirement
- Optimal for streaming responses
- Auto-scaling without cold starts

### Authentication with Auth.js v5
[Source: docs/architecture/backend-architecture.md, source-tree.md]

**Session Validation Pattern:**
```typescript
import { auth } from "@/lib/auth";

export async function POST(req: Request) {
  const session = await auth();
  if (!session?.user) {
    return new Response(
      JSON.stringify({ error: { code: "unauthorized", message: "Authentication required", statusCode: 401 } }),
      { status: 401, headers: { "Content-Type": "application/json" } }
    );
  }
  // ... rest of handler
}
```

**Key points:**
- `auth()` function from centralized config (`lib/auth.ts`)
- Returns `Session` object with `user` property or `null`
- JWT session stored in httpOnly cookie (no database lookup needed)
- Session expires after 30 days (configured in `lib/auth.ts`)

### Request/Response Schema
[Source: docs/architecture/data-models.md, Vercel AI SDK]

**Expected Request Body (Assistance UI format):**
```typescript
{
  messages: [
    { role: "user", content: "Hello" },
    { role: "assistant", content: "Response" }
  ]
}
```

**Vercel AI SDK Message Types:**
- Uses `CoreMessage` type from `ai` package
- Assistance UI sends messages compatible with AI SDK
- AI SDK handles message conversion automatically

**Validation Rules:**
- `role`: Must be "user" or "assistant" (system added server-side)
- `content`: String, 1-2000 characters
- `messages`: Array, maximum 20 messages (prevents context overflow)

**Note:** Vercel AI SDK (`streamText()`) will be used in Story 2.2, replacing placeholder response

### Input Validation with Zod
[Source: docs/architecture/backend-architecture.md]

**Zod Schema Pattern:**
```typescript
import { z } from "zod";

const ChatRequestSchema = z.object({
  messages: z.array(
    z.object({
      role: z.enum(["user", "assistant"]),
      content: z.string().min(1).max(2000),
    })
  ).max(20),
});

// Usage
const { messages } = ChatRequestSchema.parse(body);
```

**Error Handling:**
- ZodError → 422 Unprocessable Entity (client input error)
- Other errors → 500 Internal Server Error (server issue)
- Always log errors with request context for debugging

### Error Response Format
[Source: docs/architecture/backend-architecture.md]

**Standardized Error Structure:**
```typescript
{
  error: {
    code: string,        // Machine-readable error code
    message: string,     // Human-readable message
    statusCode: number,  // HTTP status code
    details?: any        // Optional additional context
  }
}
```

**Error Codes:**
- `unauthorized` - No valid session (401)
- `validation_error` - Invalid request format (422)
- `internal_error` - Server error (500)

### File Location and Structure
[Source: docs/architecture/source-tree.md]

**File Path:** `app/api/chat/route.ts`

**Directory Structure:**
```
app/
├── api/
│   ├── chat/
│   │   └── route.ts        # This story - Edge runtime
│   └── auth/
│       └── [...nextauth]/
│           └── route.ts    # Auth handlers (Node runtime)
```

**Import Path Alias:**
```typescript
// ✅ DO: Use alias
import { auth } from '@/lib/auth';

// ❌ DON'T: Use relative paths
import { auth } from '../../../lib/auth';
```

### Testing

[Source: docs/architecture/testing-strategy.md]

**Manual Testing Approach:**
Since this is MVP with 2-day timeline, use manual testing via:

1. **Browser DevTools:**
   - Network tab: Inspect request/response
   - Console: Check for client errors
   - Application tab: Verify session cookie

2. **Vercel Function Logs:**
   - Check deployment logs for Edge function initialization
   - Monitor runtime errors during testing
   - Verify request logging output

3. **Test Scenarios:**
   - No session → 401 response
   - Valid session + malformed body → 422 response
   - Valid session + valid body → Success (placeholder response for now)

**Local Testing:**
```bash
# Run dev server
npm run dev

# Test with curl (no session - expect 401)
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"messages": [{"role": "user", "content": "test"}]}'

# Test with authenticated session (use browser session cookie)
```

**Vercel Deployment Testing:**
- Deploy to preview environment
- Test with production session
- Monitor Edge function logs in Vercel dashboard

### Important Notes from Previous Stories

**From Story 1.1 (Initialize Next.js + Assistance UI):**
- Next.js 15.5.4 with App Router configured
- TypeScript 5.9.3 for type safety
- Assistance UI installed and configured

**From Story 1.2 (Auth.js Setup):**
- Auth.js v5 beta configured with Google + Email providers
- JWT sessions (no database)
- Session validation works with Edge runtime

**From Story 1.3 (Middleware Protection):**
- Middleware protects all routes except `/login`, `/api/auth/*`, static files
- Auth enforced at middleware level
- `/api/chat` will be protected by both middleware AND route-level validation (defense in depth)

### Vercel AI SDK Integration
[Source: Vercel AI SDK documentation, Oct 2025 best practices]

**Why Vercel AI SDK:**
- Clean, type-safe API for AI integration
- Built-in streaming support (SSE handled automatically)
- OpenAI-compatible providers (works with Nous API)
- Better error handling than raw fetch()
- Seamless Assistance UI integration

**Basic Pattern (Placeholder for Story 2.1):**
```typescript
import { streamText } from 'ai';
import { openai } from '@ai-sdk/openai';

export async function POST(req: Request) {
  // ... session validation, input validation ...

  const { messages } = await req.json();

  // Placeholder response (Story 2.2 will add Nous provider)
  const result = streamText({
    model: openai('gpt-4o-mini'),  // Temporary placeholder
    messages,
  });

  return result.toDataStreamResponse();
}
```

**Story 2.2 will replace with:**
```typescript
import { createOpenAI } from '@ai-sdk/openai';

const nous = createOpenAI({
  baseURL: process.env.NOUS_API_BASE_URL,
  apiKey: process.env.NOUS_API_KEY,
});

const result = streamText({
  model: nous('Hermes-4-405B'),
  system: getSystemPrompt('panel'),
  messages,
});
```

### Next Steps After This Story

**Story 2.2** will add:
- Custom Nous provider using `createOpenAI()`
- System prompt injection via `system` parameter
- Actual Hermes 4 response generation (replacing placeholder)

**For now:** Focus on solid foundation with auth, validation, and AI SDK setup. The placeholder response confirms everything works before adding Nous-specific configuration.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-08 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
- `.ai/story-2.1-test-validation.md` - Test validation checklist created during implementation

### Completion Notes List

#### Critical Discovery: UIMessage Format vs Simple Messages

**Issue Found:** Initial implementation used strict Zod validation expecting simple message format:
```typescript
{ role: "user", content: "Hello" }
```

**Actual Format:** Assistance UI sends UIMessage format with `parts` arrays:
```typescript
{
  id: "msg-1",
  role: "user",
  parts: [
    { type: "text", text: "Hello" }
  ]
}
```

**Resolution:**
1. Removed strict Zod validation for message structure
2. Used AI SDK's `convertToModelMessages()` to transform UIMessage → ModelMessage
3. Changed response from `toTextStreamResponse()` to `toUIMessageStreamResponse()`
4. Kept basic validation (array check, message count 1-20)

**Why This Matters for Future Stories:**
- Story 2.2 (Nous API integration) must use `convertToModelMessages()` pattern
- Story 2.3 (streaming) already handled by `toUIMessageStreamResponse()`
- Any custom message handling must work with UIMessage `parts` arrays

#### Implementation Approach Changes

**Original Plan (from Dev Notes):**
- Use Zod schema with `role` enum and `content` string validation
- Validate content length (1-2000 chars) and message count (max 20)
- Return `toDataStreamResponse()`

**Actual Implementation:**
- Basic validation only (array existence, count limits)
- Let AI SDK handle message format validation via `convertToModelMessages()`
- Return `toUIMessageStreamResponse()` for Assistance UI compatibility
- Added comprehensive request logging with UUID request IDs

#### Testing Results

**Build Verification:** ✅
```bash
Route (app)                                 Size  First Load JS
├ ƒ /api/chat                              126 B         102 kB
```

**Manual Browser Testing:** ✅
- Authenticated user successfully sends messages
- Streaming responses display in real-time
- Session validation working (401 on unauthenticated)
- Request logging includes: request ID, user email, message count

**Performance:**
- Edge function deploys successfully
- Placeholder model (gpt-4o-mini) streams responses quickly
- No timeout issues observed

### File List

#### Modified Files
- `app/api/chat/route.ts` - Complete rewrite with proper UIMessage handling
- `package.json` - Added `zod` v4.1.12 dependency

#### Created Files
- `.ai/story-2.1-test-validation.md` - Manual test validation checklist

### Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-08 | 1.0 | Initial story creation | Scrum Master (Bob) |
| 2025-10-08 | 1.1 | Implementation completed with UIMessage format discovery | Dev Agent (James) |

## QA Results
*(To be filled by QA agent after implementation)*
