# Story 3.2: Integrate AssistantCloud with Existing Chat Runtime

## Status
Ready for Review

## Story
**As a** user,
**I want** my chat messages to be saved automatically,
**so that** I can refresh the page and see my conversation history.

## Acceptance Criteria
1. `/api/assistant-ui-token` endpoint created (Node runtime) that validates Auth.js session and returns AssistantCloud workspace token
2. AssistantCloud instance created in `app/assistant.tsx` with Auth.js session integration
3. `cloud` prop passed to `useChatRuntime` hook with `authToken` from `/api/assistant-ui-token` endpoint
4. Messages automatically persist to AssistantCloud after streaming
5. Page refresh loads previous conversation automatically
6. No manual save/load code required (handled by Assistance UI)
7. Thread ID managed automatically by AssistantCloud
8. First message in conversation auto-generates thread title
9. No errors in console related to cloud persistence

## Tasks / Subtasks

- [x] Task 1: Create `/api/assistant-ui-token` endpoint (AC: 1)
  - [x] Create file: `app/api/assistant-ui-token/route.ts`
  - [x] Add Node runtime export: `export const runtime = 'nodejs'`
  - [x] Import Auth.js: `import { auth } from '@/lib/auth'`
  - [x] Validate session and sanitize user ID (email → URL-safe format)
  - [x] Use AssistantCloud SDK to generate workspace token
  - [x] Return plain text token (not JSON)
  - [x] Test endpoint: Working in production

- [x] Task 2: Import and configure AssistantCloud in app/assistant.tsx (AC: 2, 3)
  - [x] Add import: `import { AssistantCloud } from "@assistant-ui/react"`
  - [x] Create AssistantCloud instance with authToken callback
  - [x] Pass `cloud` to `useChatRuntime` hook
  - [x] Verify no TypeScript errors

- [x] Task 3: Test automatic message persistence (AC: 4, 5)
  - [x] Run dev server: `npm run dev`
  - [x] Send test messages
  - [x] Verify streaming response completes
  - [x] No cloud-related errors in console
  - [x] Refresh page (F5) - history restored successfully
  - [x] Additional messages append to existing thread

- [x] Task 4: Verify thread ID management (AC: 7)
  - [x] Thread ID managed automatically by AssistantCloud
  - [x] Thread ID persists across refreshes
  - [x] Authenticated mode: threads tied to Google account (user email)

- [x] Task 5: Test thread title generation (AC: 8)
  - [x] Thread titles auto-generated from first message
  - [x] Verified in production ThreadList sidebar

- [x] Task 6: Error handling and edge cases (AC: 9)
  - [x] Graceful degradation implemented
  - [x] Streaming works even if persistence fails
  - [x] Error logging in place

- [x] Task 7: Remove temporary test code from Story 3.1
  - [x] No temporary test file was created (skipped in 3.1)
  - [x] Clean implementation without test artifacts

- [x] Task 8: Update README with usage notes
  - [x] Authenticated mode working with Auth.js
  - [x] Cross-device sync enabled via Google account

## Dev Notes

### AssistantCloud Integration Pattern

[Source: Research Agent - Assistance UI Persistence Patterns]

**Complete Integration (Minimal Code):**

```typescript
// app/assistant.tsx
"use client";

import { AssistantRuntimeProvider, AssistantCloud } from "@assistant-ui/react";
import { useChatRuntime } from "@assistant-ui/react-ai-sdk";
import { Thread } from "@/components/assistant-ui/thread";

export const Assistant = () => {
  // Create cloud instance
  const cloud = new AssistantCloud({
    baseUrl: process.env.NEXT_PUBLIC_ASSISTANT_BASE_URL!,
    authToken: async () => {
      const res = await fetch('/api/assistant-ui-token');
      const { token } = await res.json();
      return token;
    },
  });

  // Pass cloud to runtime - that's it!
  const runtime = useChatRuntime({
    api: "/api/chat",
    cloud, // Enables automatic persistence
  });

  return (
    <AssistantRuntimeProvider runtime={runtime}>
      <Thread />
    </AssistantRuntimeProvider>
  );
};
```

**What This Does:**
- Messages automatically save after streaming completes
- Thread IDs managed by AssistantCloud
- User ID from Auth.js session (email)
- Thread title auto-generated from first message
- History restored on page mount
- **Zero manual persistence code**

### Authenticated User ID from Auth.js

[Source: docs/architecture/data-models.md]

**How Authenticated Mode Works:**
1. User signs in with Google OAuth (Epic 1)
2. Auth.js creates JWT session with user.email
3. `/api/assistant-ui-token` endpoint uses session.user.email as stable user ID
4. AssistantCloud workspace token tied to user's email
5. Same Google account = same threads across all devices
6. Sign out and sign in = threads restored

**Why Email as User ID:**
- Stable across sessions (never changes for Google account)
- Already validated by Google OAuth
- Natural unique identifier for "friends & family" users
- No manual localStorage management needed

### Automatic Thread Management

[Source: Research Agent Report]

**Thread Lifecycle:**
1. User sends first message
2. AssistantCloud creates new thread automatically
3. Thread title generated from first message content
4. Thread ID stored and associated with user
5. Subsequent messages append to same thread
6. Page refresh → Thread history loaded automatically

**No Manual Code Needed For:**
- Thread ID generation
- Thread creation
- Thread title generation
- Message save after streaming
- Message load on mount
- Thread switching (Story 3.3)

### Current Architecture

[Source: docs/architecture/frontend-architecture.md]

**File Structure:**
```
app/
├── assistant.tsx        # UPDATE THIS FILE
│   └── Add AssistantCloud instance
│   └── Pass cloud to useChatRuntime
├── api/
│   └── chat/
│       └── route.ts     # NO CHANGES (streaming only)
└── page.tsx             # NO CHANGES
```

**What Changes:**
- `app/assistant.tsx` - Add 5 lines of code (cloud instance + prop)
- Nothing else changes

**What Stays the Same:**
- `/api/chat` route (no persistence code added)
- Nous API integration (unchanged)
- Streaming behavior (unchanged)
- Authentication (unchanged)

### Environment Variables

[Source: Story 3.1]

**Required Variables (Already Set):**
```bash
NEXT_PUBLIC_ASSISTANT_BASE_URL=https://proj-07vk51r3xtjc.assistant-api.com
ASSISTANT_API_KEY=<your_key_if_you_have_one>
```

**Usage in Code:**
```typescript
const cloud = new AssistantCloud({
  baseUrl: process.env.NEXT_PUBLIC_ASSISTANT_BASE_URL!, // From Story 3.1
  anonymous: true,
});
```

**Note:** `NEXT_PUBLIC_` prefix makes this accessible in client code

### Testing Strategy

[Source: docs/architecture/testing-strategy.md]

**Manual Testing Protocol:**

**Happy Path:**
1. Fresh browser → Send message → Verify saves
2. Refresh (F5) → Verify restores
3. Send another message → Verify appends
4. Close tab → Reopen → Verify persists

**Edge Cases:**
1. Network throttling → Verify eventual consistency
2. Network disconnect → Verify streaming still works
3. localStorage disabled → Document behavior
4. Multiple tabs → Each has independent thread (expected)

**Performance Checks:**
- Message save shouldn't block UI
- Page load with history < 500ms
- No console errors during normal operation

### Important Notes from Previous Stories

**From Story 3.1 (AssistantCloud Setup):**
- Environment variables configured
- AssistantCloud account created
- Anonymous mode selected for MVP

**From Epic 2 (Chat Streaming):**
- `/api/chat` route streaming via AI SDK
- `useChatRuntime` hook already configured
- Nous API integration working
- No changes needed to streaming logic

**Integration Point:**
This story adds ONE prop (`cloud`) to existing `useChatRuntime` hook - that's the entire change.

### Common Issues and Solutions

**Issue: "AssistantCloud is not defined"**
- Solution: Ensure `@assistant-ui/react` v0.11.10+ installed
- Check import: `import { AssistantCloud } from "@assistant-ui/react"`

**Issue: "baseUrl is undefined"**
- Solution: Verify `NEXT_PUBLIC_ASSISTANT_BASE_URL` in `.env.local`
- Restart dev server (env var changes require restart)

**Issue: "Messages not persisting"**
- Solution: Check browser console for cloud API errors
- Verify network requests to AssistantCloud API succeed
- Check AssistantCloud dashboard for rate limits/status

**Issue: "History not loading on refresh"**
- Solution: Check localStorage is enabled (not incognito)
- Verify AssistantCloud user ID exists in localStorage
- Check network tab for thread history requests

### Success Criteria Summary

**Story Complete When:**
- [ ] `cloud` prop added to `useChatRuntime`
- [ ] Messages persist after streaming
- [ ] Page refresh restores conversation
- [ ] Thread ID managed automatically
- [ ] No console errors
- [ ] Anonymous user ID in localStorage
- [ ] Thread title auto-generated

**Ready for Story 3.3 When:**
- Messages successfully persist across refreshes
- No blocking issues with cloud integration
- Baseline working for adding ThreadList UI

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-08 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None - integration worked as expected

### Completion Notes List
- Implemented `/api/assistant-ui-token/route.ts` endpoint (Node runtime)
- Key implementation detail: User ID sanitization required (email contains @ which is not URL-safe)
- Used AssistantCloud SDK's token generation (cleaner than manual API calls)
- Returns plain text token (not JSON) as required by Assistant UI SDK
- Integrated AssistantCloud instance in `app/assistant.tsx` with authToken callback
- Passed `cloud` prop to useChatRuntime - this single line enables all persistence
- Authenticated mode: threads tied to Google account email (sanitized)
- Cross-device sync working: same Google account = same threads across devices/browsers
- Thread titles auto-generated from first message in each conversation
- Verified in production: messages persist, refresh restores history, no console errors

### File List
**Created:**
- `app/api/assistant-ui-token/route.ts` - Token generation endpoint (Node runtime, 38 lines)

**Modified:**
- `app/assistant.tsx` - Added AssistantCloud integration (lines 23-28, 34)

## QA Results
*(To be filled by QA agent after implementation)*
