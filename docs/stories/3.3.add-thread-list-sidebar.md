# Story 3.3: Add Thread List Sidebar for Conversation History

## Status
Ready for Review

## Story
**As a** user,
**I want** to see a list of my previous conversations,
**so that** I can navigate back to earlier spiritual guidance sessions.

## Acceptance Criteria
1. `<ThreadList />` component added to `app/assistant.tsx`
2. Sidebar layout implemented using `<SidebarProvider>` and `<SidebarInset>`
3. Thread list displays:
   - Thread titles (auto-generated from first message)
   - Last updated timestamp
   - Active thread indicator
4. Clicking a thread switches to that conversation
5. "New Conversation" button creates fresh thread
6. Thread list populated automatically from AssistantCloud
7. Sidebar collapsible on mobile devices
8. No custom thread management code required (built-in)

## Tasks / Subtasks

- [x] Task 1: Add Sidebar UI components to app/assistant.tsx (AC: 1, 2)
  - [x] Import sidebar components (SidebarProvider, SidebarInset, SidebarTrigger)
  - [x] Import ThreadListSidebar from assistant-ui components
  - [x] Import Separator and Button components
  - [x] Wrap existing `<Thread />` with sidebar layout
  - [x] Add `<ThreadListSidebar />` component
  - [x] Add `<SidebarTrigger />` button for collapsing
  - [x] TypeScript types resolve correctly

- [x] Task 2: Implement sidebar layout structure (AC: 2, 7)
  - [x] Implemented full sidebar layout with SidebarProvider
  - [x] Added header with SidebarTrigger, Separator, and user info
  - [x] Added Sign Out button in header
  - [x] Mobile responsive behavior working
  - [x] Sidebar collapse/expand functional

- [x] Task 3: Verify thread list population (AC: 3, 6)
  - [x] Multiple conversations appearing in thread list
  - [x] Thread titles match first messages
  - [x] Timestamps showing correctly
  - [x] List updates when new thread created
  - [x] Thread list persists across page refreshes

- [x] Task 4: Test thread switching functionality (AC: 4)
  - [x] Clicking thread loads conversation correctly
  - [x] Active thread highlighted in list
  - [x] Messages append to correct thread
  - [x] History intact when switching between threads
  - [x] Verified in production (user screenshot)

- [x] Task 5: Implement and test "New Conversation" button (AC: 5)
  - [x] "New Conversation" button functional
  - [x] Blank chat interface appears
  - [x] New thread created after first message
  - [x] Old threads remain accessible in list

- [x] Task 6: Style and polish sidebar UI
  - [x] Thread titles truncate appropriately
  - [x] Hover states implemented
  - [x] Active thread visually distinct
  - [x] Spacing and padding consistent
  - [x] Scroll behavior working with many threads

- [x] Task 7: Test mobile responsive behavior (AC: 7)
  - [x] Mobile viewport tested
  - [x] Sidebar collapses appropriately on mobile
  - [x] Sidebar open/close working
  - [x] Verified in production screenshot

- [x] Task 8: Error handling and edge cases
  - [x] Empty state handled by Assistant UI framework
  - [x] Scroll performance acceptable with multiple threads
  - [x] Graceful loading states
  - [x] No console errors during thread operations

## Dev Notes

### ThreadList Component (Built-in)

[Source: Research Agent - Assistance UI Persistence Patterns]

**ThreadList is Provided by Assistance UI:**
- No custom implementation needed
- Automatically populated from AssistantCloud
- Built-in thread switching logic
- Includes "New Conversation" button
- Responsive by default
- Styling via Tailwind/shadcn

**Usage:**
```typescript
import { ThreadListSidebar } from "@/components/assistant-ui/threadlist-sidebar";

// Component already exists (created by Assistant UI CLI)
// Just add to layout
<ThreadListSidebar />
```

### Sidebar Layout Pattern

[Source: docs/architecture/frontend-architecture.md]

**Complete Sidebar Implementation:**

```typescript
// app/assistant.tsx
"use client";

import { AssistantRuntimeProvider, AssistantCloud } from "@assistant-ui/react";
import { useChatRuntime } from "@assistant-ui/react-ai-sdk";
import { Thread } from "@/components/assistant-ui/thread";
import {
  SidebarInset,
  SidebarProvider,
  SidebarTrigger,
} from "@/components/ui/sidebar";
import { ThreadListSidebar } from "@/components/assistant-ui/threadlist-sidebar";
import { Separator } from "@/components/ui/separator";
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbList,
  BreadcrumbPage,
} from "@/components/ui/breadcrumb";

export const Assistant = () => {
  const cloud = new AssistantCloud({
    baseUrl: process.env.NEXT_PUBLIC_ASSISTANT_BASE_URL!,
    anonymous: true,
  });

  const runtime = useChatRuntime({
    api: "/api/chat",
    cloud,
  });

  return (
    <AssistantRuntimeProvider runtime={runtime}>
      <SidebarProvider>
        <div className="flex h-dvh w-full pr-0.5">
          <ThreadListSidebar />
          <SidebarInset>
            <header className="flex h-16 shrink-0 items-center gap-2 border-b px-4">
              <SidebarTrigger />
              <Separator orientation="vertical" className="mr-2 h-4" />
              <Breadcrumb>
                <BreadcrumbList>
                  <BreadcrumbItem>
                    <BreadcrumbPage>BuddhaBot</BreadcrumbPage>
                  </BreadcrumbItem>
                </BreadcrumbList>
              </Breadcrumb>
            </header>
            <div className="flex-1 overflow-hidden">
              <Thread />
            </div>
          </SidebarInset>
        </div>
      </SidebarProvider>
    </AssistantRuntimeProvider>
  );
};
```

### shadcn/ui Sidebar Components

[Source: docs/architecture/source-tree.md]

**Required Components (Already Installed):**
- `components/ui/sidebar.tsx` - Sidebar primitives
- `components/ui/separator.tsx` - Visual separator
- `components/ui/breadcrumb.tsx` - Navigation breadcrumb

**Installation (if missing):**
```bash
npx shadcn@latest add sidebar
npx shadcn@latest add separator
npx shadcn@latest add breadcrumb
```

**Note:** Assistant UI CLI likely already installed these

### Thread Switching Behavior

[Source: Research Agent Report]

**How Thread Switching Works:**
1. User clicks thread in sidebar
2. AssistantCloud runtime detects switch
3. Current thread messages cleared from UI
4. New thread messages loaded from AssistantCloud
5. Chat interface updates with new thread history
6. Active thread indicator updates in sidebar

**No Manual Code Needed:**
- `<ThreadListSidebar />` handles all click events
- AssistantCloud runtime manages thread state
- Assistance UI re-renders with new messages
- All automatic via framework

### Responsive Behavior

[Source: Components already responsive via shadcn]

**Mobile Breakpoints:**
- Desktop (≥ 768px): Sidebar visible by default
- Mobile (< 768px): Sidebar collapsed to hamburger menu
- Tablet: Sidebar collapsible

**SidebarProvider automatically handles:**
- Collapse state
- Overlay behavior on mobile
- Swipe gestures (if enabled)
- Accessible keyboard navigation

### File Locations

[Source: docs/architecture/source-tree.md]

**Files to Modify:**
- `app/assistant.tsx` - Main changes (add sidebar layout)

**Files to Verify Exist:**
- `components/assistant-ui/threadlist-sidebar.tsx` - Should already exist
- `components/ui/sidebar.tsx` - Should already exist
- `components/ui/separator.tsx` - Should already exist
- `components/ui/breadcrumb.tsx` - Should already exist

**No New Files Created** (all components already exist from Assistant UI CLI)

### Testing Strategy

[Source: docs/architecture/testing-strategy.md]

**Manual Testing Checklist:**

**Thread List Display:**
- [ ] Multiple threads visible in sidebar
- [ ] Thread titles accurate
- [ ] Timestamps show relative time ("2 hours ago")
- [ ] Active thread highlighted

**Thread Switching:**
- [ ] Click thread → loads conversation
- [ ] Active indicator updates
- [ ] Message history correct for each thread
- [ ] No message mixing between threads

**New Conversation:**
- [ ] Button creates blank chat
- [ ] New thread appears in list after first message
- [ ] Previous threads remain accessible

**Responsive:**
- [ ] Desktop: Sidebar visible
- [ ] Mobile: Sidebar collapses
- [ ] Hamburger menu toggles sidebar
- [ ] No layout shift when toggling

**Performance:**
- [ ] Thread list loads quickly (< 300ms)
- [ ] Thread switching smooth (< 200ms)
- [ ] Scroll smooth with 50+ threads
- [ ] No memory leaks on repeated switches

### Important Notes from Previous Stories

**From Story 3.2 (AssistantCloud Integration):**
- `cloud` prop already passed to `useChatRuntime`
- Messages persisting automatically
- Thread IDs managed by AssistantCloud
- Anonymous user ID in localStorage

**From Story 3.1 (AssistantCloud Setup):**
- Environment variables configured
- AssistantCloud account created
- Auth.js integration configured

**Integration Point:**
This story adds UI layer on top of existing persistence - no new backend code.

### Common Issues and Solutions

**Issue: "ThreadListSidebar component not found"**
- Solution: Verify Assistant UI CLI created this file
- Check: `components/assistant-ui/threadlist-sidebar.tsx`
- Fallback: Use generic `<ThreadList />` component

**Issue: "Sidebar not responsive on mobile"**
- Solution: Verify `<SidebarProvider>` wraps entire layout
- Check: Mobile viewport in DevTools
- Ensure proper className on container div

**Issue: "Thread list empty despite having conversations"**
- Solution: Check AssistantCloud API requests in Network tab
- Verify user ID exists in localStorage
- Check AssistantCloud dashboard for threads

**Issue: "Thread switching doesn't update messages"**
- Solution: Verify AssistantCloud runtime connected
- Check: `cloud` prop passed to `useChatRuntime`
- Look for errors in console during switch

### Success Criteria Summary

**Story Complete When:**
- [ ] Sidebar layout implemented
- [ ] Thread list visible with all conversations
- [ ] Thread switching works correctly
- [ ] New conversation button functional
- [ ] Mobile responsive behavior working
- [ ] No console errors
- [ ] Performance acceptable (< 300ms loads)

**Ready for Story 3.4 When:**
- Full thread history UI working
- Users can navigate between conversations
- Ready for production testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-08 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None - sidebar integration straightforward

### Completion Notes List
- Wrapped entire chat layout with `<SidebarProvider>` component
- Added `<ThreadListSidebar />` component (provided by Assistant UI CLI)
- Implemented responsive layout: `<div className="flex h-dvh w-full pr-0.5">`
- Added header with:
  - `<SidebarTrigger />` for collapse/expand functionality
  - `<Separator />` for visual separation
  - User display: Shows name or email from Auth.js session
  - Sign Out button with callback to /login
- ThreadList automatically populated from AssistantCloud (zero custom code)
- Thread switching handled by framework (click → load conversation)
- "New Conversation" button built into ThreadListSidebar component
- Mobile responsive: sidebar collapses automatically on smaller screens
- Production verification: User screenshot shows 3 persistent threads with titles
- All UI components from shadcn/ui already installed by Assistant UI CLI

### File List
**Modified:**
- `app/assistant.tsx` - Added complete sidebar layout (lines 52-83)

## QA Results
*(To be filled by QA agent after implementation)*
