# Story 3.3: Add Thread List Sidebar for Conversation History

## Status
Draft

## Story
**As a** user,
**I want** to see a list of my previous conversations,
**so that** I can navigate back to earlier spiritual guidance sessions.

## Acceptance Criteria
1. `<ThreadList />` component added to `app/assistant.tsx`
2. Sidebar layout implemented using `<SidebarProvider>` and `<SidebarInset>`
3. Thread list displays:
   - Thread titles (auto-generated from first message)
   - Last updated timestamp
   - Active thread indicator
4. Clicking a thread switches to that conversation
5. "New Conversation" button creates fresh thread
6. Thread list populated automatically from AssistantCloud
7. Sidebar collapsible on mobile devices
8. No custom thread management code required (built-in)

## Tasks / Subtasks

- [ ] Task 1: Add Sidebar UI components to app/assistant.tsx (AC: 1, 2)
  - [ ] Import sidebar components:
    ```typescript
    import {
      SidebarProvider,
      SidebarInset,
      SidebarTrigger,
    } from "@/components/ui/sidebar";
    import { ThreadListSidebar } from "@/components/assistant-ui/threadlist-sidebar";
    import { Separator } from "@/components/ui/separator";
    ```
  - [ ] Wrap existing `<Thread />` with sidebar layout
  - [ ] Add `<ThreadListSidebar />` component
  - [ ] Add `<SidebarTrigger />` button for collapsing
  - [ ] Verify TypeScript types resolve

- [ ] Task 2: Implement sidebar layout structure (AC: 2, 7)
  - [ ] Replace current simple layout with:
    ```typescript
    <SidebarProvider>
      <div className="flex h-dvh w-full">
        <ThreadListSidebar />
        <SidebarInset>
          <header>
            <SidebarTrigger />
            <Separator />
            {/* Breadcrumb navigation */}
          </header>
          <div className="flex-1 overflow-hidden">
            <Thread />
          </div>
        </SidebarInset>
      </div>
    </SidebarProvider>
    ```
  - [ ] Verify mobile responsive behavior
  - [ ] Test sidebar collapse/expand on mobile

- [ ] Task 3: Verify thread list population (AC: 3, 6)
  - [ ] Create multiple test conversations (3-4 different topics)
  - [ ] Verify each appears in thread list
  - [ ] Check thread titles match first messages
  - [ ] Verify timestamps show "last updated"
  - [ ] Confirm list updates when new thread created
  - [ ] Test that thread list persists across page refreshes

- [ ] Task 4: Test thread switching functionality (AC: 4)
  - [ ] Click different thread in list
  - [ ] Verify conversation loads correctly
  - [ ] Verify active thread highlighted in list
  - [ ] Send message in switched thread
  - [ ] Verify message appends to correct thread
  - [ ] Switch back to original thread
  - [ ] Verify history intact

- [ ] Task 5: Implement and test "New Conversation" button (AC: 5)
  - [ ] Verify "New Conversation" button exists in ThreadList UI
  - [ ] Click button
  - [ ] Verify blank chat interface appears
  - [ ] Send message
  - [ ] Verify new thread created and appears in list
  - [ ] Verify old threads remain in list

- [ ] Task 6: Style and polish sidebar UI
  - [ ] Verify thread titles truncate if too long
  - [ ] Add hover states for thread list items
  - [ ] Ensure active thread visually distinct
  - [ ] Test dark mode compatibility (if applicable)
  - [ ] Verify spacing and padding consistent
  - [ ] Test scroll behavior with many threads (10+)

- [ ] Task 7: Test mobile responsive behavior (AC: 7)
  - [ ] Test on mobile viewport (DevTools responsive mode)
  - [ ] Verify sidebar collapses to hamburger menu on mobile
  - [ ] Test sidebar open/close on mobile
  - [ ] Verify sidebar overlay doesn't block chat on mobile
  - [ ] Test swipe gestures (if supported)
  - [ ] Verify touch targets large enough (44px minimum)

- [ ] Task 8: Error handling and edge cases
  - [ ] Test with no conversations (empty state)
  - [ ] Test with 50+ conversations (scroll performance)
  - [ ] Test thread delete (if supported by ThreadList)
  - [ ] Test with AssistantCloud API temporarily down
  - [ ] Verify graceful loading states
  - [ ] Check console for errors during thread operations

## Dev Notes

### ThreadList Component (Built-in)

[Source: Research Agent - Assistance UI Persistence Patterns]

**ThreadList is Provided by Assistance UI:**
- No custom implementation needed
- Automatically populated from AssistantCloud
- Built-in thread switching logic
- Includes "New Conversation" button
- Responsive by default
- Styling via Tailwind/shadcn

**Usage:**
```typescript
import { ThreadListSidebar } from "@/components/assistant-ui/threadlist-sidebar";

// Component already exists (created by Assistant UI CLI)
// Just add to layout
<ThreadListSidebar />
```

### Sidebar Layout Pattern

[Source: docs/architecture/frontend-architecture.md]

**Complete Sidebar Implementation:**

```typescript
// app/assistant.tsx
"use client";

import { AssistantRuntimeProvider, AssistantCloud } from "@assistant-ui/react";
import { useChatRuntime } from "@assistant-ui/react-ai-sdk";
import { Thread } from "@/components/assistant-ui/thread";
import {
  SidebarInset,
  SidebarProvider,
  SidebarTrigger,
} from "@/components/ui/sidebar";
import { ThreadListSidebar } from "@/components/assistant-ui/threadlist-sidebar";
import { Separator } from "@/components/ui/separator";
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbList,
  BreadcrumbPage,
} from "@/components/ui/breadcrumb";

export const Assistant = () => {
  const cloud = new AssistantCloud({
    baseUrl: process.env.NEXT_PUBLIC_ASSISTANT_BASE_URL!,
    anonymous: true,
  });

  const runtime = useChatRuntime({
    api: "/api/chat",
    cloud,
  });

  return (
    <AssistantRuntimeProvider runtime={runtime}>
      <SidebarProvider>
        <div className="flex h-dvh w-full pr-0.5">
          <ThreadListSidebar />
          <SidebarInset>
            <header className="flex h-16 shrink-0 items-center gap-2 border-b px-4">
              <SidebarTrigger />
              <Separator orientation="vertical" className="mr-2 h-4" />
              <Breadcrumb>
                <BreadcrumbList>
                  <BreadcrumbItem>
                    <BreadcrumbPage>BuddhaBot</BreadcrumbPage>
                  </BreadcrumbItem>
                </BreadcrumbList>
              </Breadcrumb>
            </header>
            <div className="flex-1 overflow-hidden">
              <Thread />
            </div>
          </SidebarInset>
        </div>
      </SidebarProvider>
    </AssistantRuntimeProvider>
  );
};
```

### shadcn/ui Sidebar Components

[Source: docs/architecture/source-tree.md]

**Required Components (Already Installed):**
- `components/ui/sidebar.tsx` - Sidebar primitives
- `components/ui/separator.tsx` - Visual separator
- `components/ui/breadcrumb.tsx` - Navigation breadcrumb

**Installation (if missing):**
```bash
npx shadcn@latest add sidebar
npx shadcn@latest add separator
npx shadcn@latest add breadcrumb
```

**Note:** Assistant UI CLI likely already installed these

### Thread Switching Behavior

[Source: Research Agent Report]

**How Thread Switching Works:**
1. User clicks thread in sidebar
2. AssistantCloud runtime detects switch
3. Current thread messages cleared from UI
4. New thread messages loaded from AssistantCloud
5. Chat interface updates with new thread history
6. Active thread indicator updates in sidebar

**No Manual Code Needed:**
- `<ThreadListSidebar />` handles all click events
- AssistantCloud runtime manages thread state
- Assistance UI re-renders with new messages
- All automatic via framework

### Responsive Behavior

[Source: Components already responsive via shadcn]

**Mobile Breakpoints:**
- Desktop (≥ 768px): Sidebar visible by default
- Mobile (< 768px): Sidebar collapsed to hamburger menu
- Tablet: Sidebar collapsible

**SidebarProvider automatically handles:**
- Collapse state
- Overlay behavior on mobile
- Swipe gestures (if enabled)
- Accessible keyboard navigation

### File Locations

[Source: docs/architecture/source-tree.md]

**Files to Modify:**
- `app/assistant.tsx` - Main changes (add sidebar layout)

**Files to Verify Exist:**
- `components/assistant-ui/threadlist-sidebar.tsx` - Should already exist
- `components/ui/sidebar.tsx` - Should already exist
- `components/ui/separator.tsx` - Should already exist
- `components/ui/breadcrumb.tsx` - Should already exist

**No New Files Created** (all components already exist from Assistant UI CLI)

### Testing Strategy

[Source: docs/architecture/testing-strategy.md]

**Manual Testing Checklist:**

**Thread List Display:**
- [ ] Multiple threads visible in sidebar
- [ ] Thread titles accurate
- [ ] Timestamps show relative time ("2 hours ago")
- [ ] Active thread highlighted

**Thread Switching:**
- [ ] Click thread → loads conversation
- [ ] Active indicator updates
- [ ] Message history correct for each thread
- [ ] No message mixing between threads

**New Conversation:**
- [ ] Button creates blank chat
- [ ] New thread appears in list after first message
- [ ] Previous threads remain accessible

**Responsive:**
- [ ] Desktop: Sidebar visible
- [ ] Mobile: Sidebar collapses
- [ ] Hamburger menu toggles sidebar
- [ ] No layout shift when toggling

**Performance:**
- [ ] Thread list loads quickly (< 300ms)
- [ ] Thread switching smooth (< 200ms)
- [ ] Scroll smooth with 50+ threads
- [ ] No memory leaks on repeated switches

### Important Notes from Previous Stories

**From Story 3.2 (AssistantCloud Integration):**
- `cloud` prop already passed to `useChatRuntime`
- Messages persisting automatically
- Thread IDs managed by AssistantCloud
- Anonymous user ID in localStorage

**From Story 3.1 (AssistantCloud Setup):**
- Environment variables configured
- AssistantCloud account created
- Auth.js integration configured

**Integration Point:**
This story adds UI layer on top of existing persistence - no new backend code.

### Common Issues and Solutions

**Issue: "ThreadListSidebar component not found"**
- Solution: Verify Assistant UI CLI created this file
- Check: `components/assistant-ui/threadlist-sidebar.tsx`
- Fallback: Use generic `<ThreadList />` component

**Issue: "Sidebar not responsive on mobile"**
- Solution: Verify `<SidebarProvider>` wraps entire layout
- Check: Mobile viewport in DevTools
- Ensure proper className on container div

**Issue: "Thread list empty despite having conversations"**
- Solution: Check AssistantCloud API requests in Network tab
- Verify user ID exists in localStorage
- Check AssistantCloud dashboard for threads

**Issue: "Thread switching doesn't update messages"**
- Solution: Verify AssistantCloud runtime connected
- Check: `cloud` prop passed to `useChatRuntime`
- Look for errors in console during switch

### Success Criteria Summary

**Story Complete When:**
- [ ] Sidebar layout implemented
- [ ] Thread list visible with all conversations
- [ ] Thread switching works correctly
- [ ] New conversation button functional
- [ ] Mobile responsive behavior working
- [ ] No console errors
- [ ] Performance acceptable (< 300ms loads)

**Ready for Story 3.4 When:**
- Full thread history UI working
- Users can navigate between conversations
- Ready for production testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-08 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
*(To be filled by Dev Agent)*

### Debug Log References
*(To be filled by Dev Agent)*

### Completion Notes List
*(To be filled by Dev Agent)*

### File List
*(To be filled by Dev Agent)*

## QA Results
*(To be filled by QA agent after implementation)*
