# Story 3.4: Verify End-to-End Persistence in Production

## Status
Draft

## Story
**As a** user,
**I want** confidence that my conversations are reliably saved and restored,
**so that** I can trust the system to maintain continuity in my spiritual practice.

## Acceptance Criteria
1. Full persistence flow tested in production:
   - Send message → message saved to AssistantCloud
   - Refresh page (F5) → active conversation restored with full history
   - Send another message → appends to existing thread
   - Navigate away and return → full history intact
   - Close browser and reopen → last active conversation restored (if localStorage intact)
2. Thread list functionality verified:
   - Multiple threads per user working correctly
   - Thread switching maintains history
   - New thread creation works
   - Thread titles auto-generated accurately
3. Performance verified:
   - History load time < 500ms
   - Message save doesn't block streaming response
   - Thread list loads quickly (< 300ms)
4. Anonymous mode verified:
   - Browser session creates unique user ID
   - User ID stored in localStorage
   - Different browsers = different user sessions (expected)
   - Incognito mode creates separate session (expected)
5. Error scenarios tested:
   - AssistantCloud unavailable (graceful degradation - streaming still works)
   - localStorage unavailable (fallback behavior documented)
   - Network issues during save (retry behavior verified)
6. Cross-browser testing:
   - Chrome (desktop + mobile)
   - Safari (desktop + mobile)
   - Firefox (desktop)

## Tasks / Subtasks

- [ ] Task 1: Deploy to Vercel production with AssistantCloud env vars (AC: 1)
  - [ ] Verify Vercel environment variables set:
    - `NEXT_PUBLIC_ASSISTANT_BASE_URL` (Production scope)
    - `ASSISTANT_API_KEY` (if applicable)
    - All Auth.js variables from Epic 1
    - All Nous API variables from Epic 2
  - [ ] Deploy latest code: `git push origin main`
  - [ ] Verify deployment successful in Vercel dashboard
  - [ ] Check build logs for errors
  - [ ] Verify Edge function deployed for `/api/chat`

- [ ] Task 2: Test full persistence flow in production (AC: 1)
  - [ ] Navigate to production URL
  - [ ] Sign in with Google OAuth
  - [ ] Send message: "Hello, can you introduce yourself?"
  - [ ] Wait for full streaming response
  - [ ] Open browser DevTools → Application → localStorage
  - [ ] Verify AssistantCloud user ID exists
  - [ ] **Refresh page (F5)**
  - [ ] Verify conversation restored with all messages
  - [ ] Send follow-up: "What is the nature of suffering?"
  - [ ] Verify appends to same thread
  - [ ] **Close browser completely**
  - [ ] Reopen browser → Navigate to production URL
  - [ ] Verify conversation restored

- [ ] Task 3: Test thread list and switching (AC: 2)
  - [ ] Create 3 different conversations with topics:
    - "What is the nature of suffering?"
    - "How do I practice mindfulness?"
    - "Can you explain non-attachment?"
  - [ ] Verify all 3 appear in thread list sidebar
  - [ ] Verify thread titles match first questions
  - [ ] Click second thread
  - [ ] Verify conversation switches correctly
  - [ ] Send message in second thread
  - [ ] Verify appends to correct thread
  - [ ] Switch to third thread
  - [ ] Verify history intact
  - [ ] Click "New Conversation" button
  - [ ] Verify blank chat appears
  - [ ] Send message
  - [ ] Verify 4th thread created

- [ ] Task 4: Measure and verify performance (AC: 3)
  - [ ] Open browser DevTools → Network tab
  - [ ] Clear cache and hard reload
  - [ ] Measure initial page load time
  - [ ] Click existing thread with 10+ messages
  - [ ] Measure thread load time (should be < 500ms)
  - [ ] Open thread list (if collapsed)
  - [ ] Measure thread list load time (should be < 300ms)
  - [ ] Send new message
  - [ ] Verify streaming starts immediately (not blocked by save)
  - [ ] Check Network tab for AssistantCloud save request
  - [ ] Verify save happens after streaming completes

- [ ] Task 5: Verify anonymous mode behavior (AC: 4)
  - [ ] **Same browser test:**
    - [ ] Send message
    - [ ] Refresh page
    - [ ] Verify conversation restored
  - [ ] **Different browser test:**
    - [ ] Open Firefox (if using Chrome)
    - [ ] Navigate to production URL
    - [ ] Verify blank chat (no threads from Chrome)
    - [ ] Send message
    - [ ] Verify new user ID in localStorage
  - [ ] **Incognito mode test:**
    - [ ] Open incognito/private window
    - [ ] Navigate to production URL
    - [ ] Verify blank chat (separate session)
    - [ ] Send message
    - [ ] Close incognito window
    - [ ] Reopen incognito → Navigate to URL
    - [ ] Verify conversation lost (expected for incognito)
  - [ ] **localStorage inspection:**
    - [ ] DevTools → Application → localStorage
    - [ ] Identify AssistantCloud user ID key
    - [ ] Copy user ID value
    - [ ] Document key name in README

- [ ] Task 6: Test error scenarios and graceful degradation (AC: 5)
  - [ ] **AssistantCloud API down:**
    - [ ] Block `assistant-api.com` in DevTools (Network → Request blocking)
    - [ ] Send message
    - [ ] Verify streaming still works (Nous API unaffected)
    - [ ] Check console for clear error message about persistence
    - [ ] Unblock API
    - [ ] Refresh page
    - [ ] Verify messages not saved (expected)
  - [ ] **localStorage unavailable:**
    - [ ] Use incognito + block storage (browser settings)
    - [ ] Send message
    - [ ] Document behavior (likely fails gracefully or uses session storage)
  - [ ] **Network throttling:**
    - [ ] DevTools → Network → Slow 3G
    - [ ] Send message
    - [ ] Verify streaming works (may be slow)
    - [ ] Verify message eventually saves
    - [ ] Check for retry logic in Network tab

- [ ] Task 7: Cross-browser testing (AC: 6)
  - [ ] **Desktop Chrome:**
    - [ ] Full flow: login → chat → refresh → verify
    - [ ] Thread list → switching → verify
    - [ ] Performance acceptable
  - [ ] **Desktop Safari:**
    - [ ] Same tests as Chrome
    - [ ] Check for Safari-specific issues
    - [ ] Verify localStorage works in Safari
  - [ ] **Desktop Firefox:**
    - [ ] Same tests as Chrome
    - [ ] Verify no Firefox-specific errors
  - [ ] **Mobile Chrome (Android or iOS):**
    - [ ] Responsive layout works
    - [ ] Thread list sidebar collapsible
    - [ ] Touch interactions smooth
    - [ ] Persistence works on mobile
  - [ ] **Mobile Safari (iOS):**
    - [ ] Same mobile tests
    - [ ] Verify iOS Safari localStorage quirks handled
    - [ ] Test PWA behavior (if applicable)

- [ ] Task 8: Invite initial test users (2-3 friends/family)
  - [ ] Share production URL with test users
  - [ ] Provide brief instructions:
    - "Sign in with Google"
    - "Try having a conversation"
    - "Refresh the page - your messages should remain"
    - "Try creating multiple conversations via sidebar"
  - [ ] Monitor Vercel logs during testing
  - [ ] Collect feedback:
    - Did persistence work as expected?
    - Any confusing behaviors?
    - Performance acceptable?
    - Any errors encountered?
  - [ ] Document feedback for post-Epic iteration

- [ ] Task 9: Production monitoring and health check
  - [ ] Verify Vercel function metrics:
    - `/api/chat` invocations normal
    - Execution duration within limits
    - Error rate < 5%
  - [ ] Check for AssistantCloud API errors in logs
  - [ ] Verify no rate limiting issues
  - [ ] Monitor AssistantCloud dashboard (if available):
    - Thread creation rate
    - Message persistence rate
    - API usage/quotas
  - [ ] Check for client-side errors (Vercel Analytics if enabled)

- [ ] Task 10: Document production setup and known behaviors
  - [ ] Update README with:
    - Chat history persistence now enabled
    - Anonymous mode behavior (per-browser sessions)
    - How to start new conversation
    - How to switch between threads
    - Known limitations (incognito mode, cross-device)
  - [ ] Create user guide (if needed):
    - How to use thread list
    - How to manage conversations
    - What to expect with page refresh
  - [ ] Document any known issues or workarounds
  - [ ] Add troubleshooting section for common problems

## Dev Notes

### End-to-End Flow Architecture

[Source: docs/architecture/frontend-architecture.md, docs/prd/epic-3-chat-history-persistence.md]

**Complete Persistence Flow:**
```
1. User navigates to / → Middleware checks session
   ↓
2. If no session → Redirect to /login
   ↓
3. User signs in (Google) → Auth.js creates JWT session
   ↓
4. Redirect to / → Chat interface loads
   ↓
5. AssistantCloud checks localStorage for user ID
   ↓
6. If user ID exists → Load user's threads
   ↓
7. User sends message → Assistance UI POST to /api/chat
   ↓
8. Edge function streams from Nous API
   ↓
9. After streaming completes → AssistantCloud saves message
   ↓
10. Thread updated with new message
   ↓
11. User refreshes page (F5)
   ↓
12. AssistantCloud loads threads and messages
   ↓
13. Assistance UI renders with full history
```

**Critical Integration Points:**
- Middleware → Session validation
- Auth.js → JWT session creation
- AssistantCloud → User ID generation (anonymous)
- Assistance UI → Automatic message persistence
- AssistantCloud → Thread and message storage
- Assistance UI → History restoration on mount

### Anonymous Mode User Behavior

[Source: docs/architecture/data-models.md]

**Expected Behaviors:**

| Scenario | Expected Result | Verification |
|----------|----------------|--------------|
| Same browser, same user | Conversations persist | ✅ Should work |
| Refresh page (F5) | History restored | ✅ Should work |
| Close/reopen browser | History restored | ✅ Should work |
| Different browser | New user session | ✅ Expected (not a bug) |
| Incognito mode | Separate session | ✅ Expected (not a bug) |
| Clear localStorage | History lost | ✅ Expected (not a bug) |
| Different device | New user session | ✅ Expected (not a bug) |

**Document These as Features, Not Bugs:**
- Anonymous mode = per-browser user identity
- Cross-device sync requires authenticated mode (post-MVP)
- Incognito mode is intentionally separate session

### Performance Benchmarks

[Source: docs/prd/epic-3-chat-history-persistence.md]

**Performance Targets:**

| Metric | Target | Measurement Method | Acceptable Range |
|--------|--------|-------------------|------------------|
| Thread History Load | < 500ms | DevTools Network TTFB | 100ms - 500ms |
| Thread List Load | < 300ms | DevTools Network time | 50ms - 300ms |
| Message Save | Non-blocking | Verify streaming unaffected | After stream completes |
| Thread Switch | < 200ms | Time to render new messages | 50ms - 200ms |

**How to Measure:**

1. **Browser DevTools (Network Tab):**
   ```
   - Click thread in sidebar
   - Find AssistantCloud API request
   - Check "Time" column for total duration
   ```

2. **Performance Tab:**
   ```
   - Record → Click thread → Stop
   - Analyze user timing marks
   - Check for jank or long tasks
   ```

3. **User Perception:**
   ```
   - Does it feel instant? (< 100ms)
   - Acceptable? (100-300ms)
   - Noticeable delay? (> 300ms)
   ```

### Error Scenario Testing Matrix

[Source: Epic 3 PRD Risk Mitigation]

| Error Type | How to Test | Expected Result | Verify |
|------------|-------------|-----------------|--------|
| AssistantCloud API Down | Block `assistant-api.com` in DevTools | Streaming works, persistence fails gracefully | ✅ Error logged, user notified |
| Network Failure | DevTools → Offline | Can't send messages | ✅ User-friendly message |
| localStorage Disabled | Incognito + block storage | New user ID each session | ✅ Document behavior |
| Slow Network | Slow 3G throttling | Delayed saves | ✅ Eventually consistent |
| Rate Limiting | Rapid thread creation | 429 errors from cloud | ✅ Graceful error handling |

**Graceful Degradation Verification:**
- Streaming NEVER blocked by persistence failures
- User can always send messages (even if not saving)
- Clear error messages (not cryptic failures)
- App doesn't crash on cloud API errors

### Production Environment Configuration

[Source: docs/prd/6-configuration-environment-variables.md]

**Required Vercel Environment Variables:**

```bash
# Authentication (from Epic 1)
NEXTAUTH_URL=https://buddah-bot.vercel.app  # Actual production URL
NEXTAUTH_SECRET=<production_secret>          # NEW - don't reuse dev
AUTH_GOOGLE_ID=<google_client_id>
AUTH_GOOGLE_SECRET=<google_client_secret>
EMAIL_FROM=noreply@yourdomain.com            # If email auth enabled
RESEND_API_KEY=<resend_key>                  # If email auth enabled

# Nous API (Epic 2)
NOUS_API_BASE_URL=https://api.nousresearch.com/v1
NOUS_API_KEY=<nous_api_key>
HERMES_MODEL=Hermes-4-405B
BUDDAHBOT_MODE=panel

# AssistantCloud (Epic 3)
NEXT_PUBLIC_ASSISTANT_BASE_URL=https://proj-07vk51r3xtjc.assistant-api.com
ASSISTANT_API_KEY=<api_key_if_you_have_one>
```

**Environment Variable Checklist:**
- [ ] All variables set in Vercel Dashboard
- [ ] Production scope selected (not preview/dev)
- [ ] `NEXTAUTH_SECRET` is NEW (not reused from dev)
- [ ] `NEXTAUTH_URL` matches actual Vercel URL
- [ ] `NEXT_PUBLIC_ASSISTANT_BASE_URL` accessible from client
- [ ] Google OAuth callback URLs updated in Google Console

### Cross-Browser Compatibility

[Source: docs/architecture/tech-stack.md, Story 2.4]

**Browser Support Matrix:**

| Browser | Version | Streaming | Persistence | localStorage | Notes |
|---------|---------|-----------|-------------|--------------|-------|
| Chrome | 90+ | ✅ SSE native | ✅ | ✅ | Primary target |
| Safari | 14+ | ✅ SSE native | ✅ | ✅ | Test thoroughly |
| Firefox | 88+ | ✅ SSE native | ✅ | ✅ | Should work |
| Edge | 90+ | ✅ SSE native | ✅ | ✅ | Chromium-based |
| Mobile Safari | iOS 14+ | ✅ SSE native | ✅ | ⚠️ Quirks | Test carefully |
| Mobile Chrome | Android 90+ | ✅ SSE native | ✅ | ✅ | Test on device |

**Known Issues:**
- Older Safari (< 14) may have SSE issues
- Mobile browsers may throttle background tabs
- Safari Private Browsing blocks some localStorage (expected)

**Testing Checklist:**
- [ ] Desktop Chrome → Full flow works
- [ ] Desktop Safari → Full flow works
- [ ] Desktop Firefox → Full flow works
- [ ] Mobile Safari → Persistence works, UI responsive
- [ ] Mobile Chrome → Persistence works, UI responsive

### User Feedback Collection

[Source: docs/prd/2-success-criteria.md]

**Initial User Testing Protocol:**
- **Who:** 2-3 trusted friends/family
- **What to test:** Full persistence flow with multiple conversations
- **Feedback to collect:**
  - Did messages persist as expected?
  - Was thread list intuitive?
  - Any confusing behaviors?
  - Performance acceptable?
  - Any errors encountered?

**Feedback Questions:**
1. How was the persistence experience? (1-5 scale)
2. Did the thread list make sense? (yes/no/suggestions)
3. Was switching between conversations smooth? (yes/no)
4. Any errors or confusing moments?
5. Would you trust this for ongoing conversations? (yes/no/why)

**Document Feedback:**
- Create `docs/user-feedback-epic3.md` (optional)
- Note common themes
- Identify improvement opportunities
- Plan for post-MVP iteration based on feedback

### Testing Strategy Summary

[Source: docs/architecture/testing-strategy.md]

**Manual Testing Protocol:**

**Pre-Deployment Checklist:**
- [ ] All environment variables set in Vercel
- [ ] Latest code deployed
- [ ] Build successful (no errors)
- [ ] AssistantCloud account active

**Core Flow Testing:**
1. **Authentication:**
   - [ ] Google OAuth works
   - [ ] Session persists across refresh
   - [ ] Sign out works

2. **Chat Persistence:**
   - [ ] Send message → saves automatically
   - [ ] Refresh → conversation restored
   - [ ] New message → appends to thread
   - [ ] Close/reopen browser → history intact

3. **Thread Management:**
   - [ ] Multiple threads created
   - [ ] Thread list displays all conversations
   - [ ] Thread switching works
   - [ ] New conversation button works

4. **Error Handling:**
   - [ ] AssistantCloud down → graceful degradation
   - [ ] Network errors → clear messages
   - [ ] localStorage disabled → documented behavior

5. **Performance:**
   - [ ] Thread load < 500ms
   - [ ] Thread list < 300ms
   - [ ] No blocking during message save
   - [ ] Smooth thread switching

**Production Monitoring (First 48 Hours):**
- Check Vercel logs every few hours
- Monitor for persistence errors
- Track AssistantCloud API usage
- Watch for rate limiting issues
- Monitor user feedback

### Important Notes from Previous Stories

**From Story 3.3 (Thread List Sidebar):**
- Sidebar UI implemented
- Thread list showing all conversations
- Thread switching working
- Mobile responsive layout

**From Story 3.2 (AssistantCloud Integration):**
- `cloud` prop integrated with runtime
- Messages persisting automatically
- Page refresh restoring history
- Anonymous user ID in localStorage

**From Story 3.1 (AssistantCloud Setup):**
- AssistantCloud account created
- Environment variables configured
- Anonymous mode enabled
- Connection tested successfully

**Integration Point:**
This story validates ALL Epic 3 work in production with real users.

### Success Criteria Summary

**Epic 3 is COMPLETE when:**
- [ ] Full persistence flow works in production
- [ ] Thread list displays all conversations
- [ ] Thread switching maintains history
- [ ] Performance targets met (< 500ms history load)
- [ ] Anonymous mode behavior verified and documented
- [ ] Error scenarios tested and handled gracefully
- [ ] Cross-browser compatibility verified
- [ ] Initial users (2-3 friends/family) tested successfully
- [ ] No critical bugs found
- [ ] User feedback collected and documented

**Ready for Post-MVP Iteration when:**
- Users successfully having multi-session conversations
- Persistence reliable and performant
- System stable across browsers and devices
- Feedback documented for future enhancements

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-08 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
*(To be filled by Dev Agent)*

### Debug Log References
*(To be filled by Dev Agent)*

### Completion Notes List
*(To be filled by Dev Agent)*

### File List
*(To be filled by Dev Agent)*

## QA Results
*(To be filled by QA agent after implementation)*
